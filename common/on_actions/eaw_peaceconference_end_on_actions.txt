on_actions = {
	#ROOT is winner #FROM is loser
	on_peaceconference_ended = {
		effect = {
			# PUT EVERYTHING IN THE IF BELOW
			# THE bypass_on_peaceconference_ended FLAG **HAS** TO BE SET BEFORE CALLING THE white_peace COMMAND AND CLEARED AFTERWARDS
			if = {
				limit = {
					NOT = {
						has_country_flag = bypass_on_peaceconference_ended
						FROM = { has_country_flag = bypass_on_peaceconference_ended }
					}
				}
				log = "[GetDateText]: ROOT: [Root.GetName] FROM: [From.GetName] on_peaceconference_ended"
				transfer_impassible_states_back = yes
				if = {
					limit = {
						FROM = {
							is_subject = yes
						}
					}
					every_country_with_original_tag = {
						original_tag_to_check = FROM
						limit = {
							NOT = { tag = FROM }
							is_subject = yes
							is_ai = yes
							overlord = { is_ai = yes }
						}
						FROM = {
							annex_country = { target = PREV transfer_troops = yes }
						}
					}
				}
				if = {
					limit = {
						is_in_array = { annex_compliance = FROM }
					}
					remove_from_array = {
						annex_compliance = FROM
					}
				}
				if = {
					limit = {
						is_in_array = { annex_compliance_subject = FROM }
					}
					remove_from_array = {
						annex_compliance_subject = FROM
					}
				}
				set_AI_strategies_on_every_possible_country_delayed = yes
				FROM = { clr_country_flag = already_capitulated }
				if = {
					limit = {
						FROM = { tag = FAW exists = no }
					}
					for_each_scope_loop = {
						array = FAW.core_states
						add_core_of = FAT
						remove_core_of = FAW
					}
				}
				if = {
					limit = {
						NOT = { HLQ = { owns_state = 387 } }
					}
					reset_province_name = 8079
				}
				if = {
					limit = {
						NOT = { HLQ = { owns_state = 619 } }
					}
					reset_province_name = 5013
				}
				if = {
					limit = {
						NOT = { HLQ = { owns_state = 645 } }
					}
					reset_province_name = 11911
				}
				handle_op_paperclip = yes
				if = {
					limit = {
						original_tag = SCS
						owns_state = 3
					}
					SCS = {
						country_event = { id = scs.776 days = 4 }
					}
				}
				else_if = {
					limit = {
						FROM = {
							original_tag = GFF
							is_subject_of = ROOT
						}
						GRF = { is_subject_of = ROOT }
					}
					GRF = {
						set_country_flag = { flag = bypass_annex_compliance days = 1 value = 1 }
						annex_country = { target = FROM }
					}
				}
				else_if = {
					limit = {
						tag = CHN
						FROM = {
							tag = CCN
						}
					}
					set_country_flag = { flag = bypass_annex_compliance days = 1 value = 1 }
					annex_country = { target = FROM }
				}
				else_if = {
					limit = {
						tag = CCN
						FROM = {
							tag = CHN
						}
					}
					set_country_flag = { flag = bypass_annex_compliance days = 1 value = 1 }
					annex_country = { target = FROM }
				}
				else_if = {
					limit = {
						tag = STG
						is_ai = yes
						has_government = communism
						FROM = {
							tag = PLB
							PLB = { is_subject_of = ROOT }
						}
					}
					every_owned_state = {
						limit = {
							is_core_of = PLB
							NOT = {
								is_core_of = ROOT
								is_claimed_by = ROOT
							}
						}
						transfer_state_to = PLB
					}
				}
				else_if = {
					limit = {
						is_eqs_civil_war_tag = yes
						NOT = {
							original_tag = EQS
							original_tag = NLR
						}
						FROM = {
							is_eqs_civil_war_tag = yes
						}
					}
					set_country_flag = { flag = bypass_annex_compliance days = 1 value = 1 }
					annex_country = { target = FROM }
				}
				else_if = {
					limit = {
						original_tag = HLQ
						FROM = {
							OR = {
								original_tag = LNS
								original_tag = LSC
								original_tag = LSM
							}
							is_subject_of = ROOT
						}
					}
					set_country_flag = { flag = bypass_annex_compliance days = 1 value = 1 }
					annex_country = { target = FROM }
				}
				else_if = {
					limit = {
						OR = {
							original_tag = LNS
							original_tag = LSC
							original_tag = LSM
						}
						FROM = {
							OR = {
								original_tag = LNS
								original_tag = LSC
								original_tag = LSM
								original_tag = HLQ
							}
							is_subject_of = ROOT
						}
					}
					set_country_flag = { flag = bypass_annex_compliance days = 1 value = 1 }
					annex_country = { target = FROM }
				}


				if = {
					limit = {
						FROM = { has_idea = EQC_funding_the_resistiance }
					}
					FROM = { remove_ideas = EQC_funding_the_resistiance }
					EQS = { remove_ideas = EQC_resistance }
					ELF = { remove_ideas = EQC_resistance }
				}

				if = {
					limit = {
						FROM = {
							tag = GRI
							GRI_synovial = { is_unit_leader = yes }
						}
					}
					remove_ideas = CHN_GRI_Attache_For_GRI
					CHN = { remove_ideas = CHN_GRI_Attache_For_CHN }
					FROM = {
						GRI_thranx = { set_nationality = CHN }
						GRI_synovial = {
							set_nationality = CHN
							set_portraits = {
								army = { large ="GFX_Synovial_CHN_cap" }
							}
						}
					}
				}

				if = {
					limit = {
						tag = CHN
						has_country_leader = { ruling_only = yes character = CHN_queen_chrysalis }
					}
					country_event = { id = changelings_paxchrysalia.1000 hours = 1 } #it has triggers inside
					if = {
						limit = {
							FROM = {
								OR = {
									original_tag = EQS
									original_tag = NLR
								}
							}
						}
						if = {
							limit = { country_exists = FROM FROM = { is_subject_of = ROOT } }
							annex_country = { target = FROM }
						}
						country_event = news.1121
					}
				}

				else_if = {
					limit = {
						FROM = { tag = CHN }
					}
					STG = { country_event = { id = stalliongrad.151 days = 2 } }
					GRI = { country_event = { id = changelingattache.14 days = 1 } }
					if = {
						limit = {
							FROM = {
								OR = {
									has_government = democratic
									has_government = communism
								}
								OR = {
									has_character = CHN_trimmel
									has_character = CHN_vect
									has_character = CHN_opteris
								}
							}
						}

						# SOL is used as limbo
						CHN_trimmel = { set_nationality = SOL }
						CHN_vect = { set_nationality = SOL }
						CHN_opteris = { set_nationality = SOL }

						if = {
							limit = { original_tag = STG }
							country_event = { id = news.2201 days = 1 }
						}
					}
				}

				if = { # No effects
					limit = {
						has_government = communism
						FROM = {
							is_subject_of = ROOT
						}
					}
				}

				if = {
					limit = { original_tag = EQS }
					if = {
						limit = {
							FROM = {
								is_major = yes
								NOT = {
									tag = CHN
									original_tag = OLE
								}
							}
						}
						set_country_flag = EQS_had_big_war
						country_event = { id = equestriadem.8 days = 60 }
					}
					if = {
						limit = {
							is_ai = yes
							has_government = democratic
							any_owned_state = {
								is_core_of = OLE
							}
						}
						if = {
							limit = { NOT = { country_exists = OLE } }
							release_puppet = OLE
							OLE = {
								if = {
									limit = {
										ROOT = {
											original_tag = EQS
											is_in_tech_sharing_group = equestrian_research
										}
									}
									add_to_tech_sharing_group = equestrian_research
								}
								if = {
									limit = {
										has_country_flag = OLE_CHN_puppet
									}
									fire_OLE_CHN_puppet_removal = yes
								}
							}
						}
						if = {
							limit = { OLE = { OR = { is_in_faction_with = ROOT is_subject_of = ROOT } } }
							OLE = {
								every_core_state = {
									limit = {
										owner = {
											OR = {
												tag = ROOT
												AND = {
													is_in_faction_with = ROOT
													is_ai = yes
												}
											}
										}
									}
									transfer_state_to = OLE
								}
							}
							if = {
								limit = {
									OLE = {
										NOT = {
											has_country_leader = { ruling_only = yes character = OLE_queen_velvet }
										}
									}
								}
								OLE = {
									promote_character = {
										character = OLE_queen_velvet
										ideology = conservatism
									}
								}
							}
						}
					}
					if = {
						limit = {
							FROM = { tag = CHN }
						}
						country_event = { id = news.2101 days = 1 }
						country_event = { id = equestriadem.8 days = 60 }
						if = {
							limit = {
								is_ai = yes
								FROM = { is_subject_of = ROOT }
							}
							every_owned_state = {
								limit = {
									is_core_of = FROM
								}
								transfer_state_to = FROM
							}
						}
					}
					if = {
						limit = {
							has_global_flag = equestrian_civil_war
							FROM = { tag = NLR }
						}
						country_event = { id = news.2031 days = 1 }
						country_event = { id = equestriadem.8 days = 60 }
						if = {
							limit = { country_exists = FROM }
							annex_country = { target = FROM }
						}
					}
					if = {
						limit = {
							FROM = { original_tag = CRY }

						}
						if = {
							limit = {
								has_global_flag = the_crystal_war
							}
							news_event = { id = news.42 days = 1}
							clr_global_flag = the_crystal_war
						}
						remove_opinion_modifier = { target = FROM modifier = mortal_enemies }
						FROM = { remove_opinion_modifier = { target = ROOT modifier = mortal_enemies } }
					}
				}

				else_if = {
					limit = {
						original_tag = CRY
						FROM = { tag = NLR }
						has_government = democratic
						has_global_flag = SOL_wartime_change
						has_country_flag = Supported_SOL
						event_target:solar_empire = { has_war = no }
						is_subject_of = event_target:solar_empire
						NOT = {
							event_target:solar_empire = { has_completed_focus = Crystal_Fair }
							has_country_flag = supported_SOL
							has_country_flag = CRY_solar_governorship
							has_country_flag = CRY_dont_give_SOL_cosmetic
						}
					}
					set_country_flag = CRY_thinking_about_staying_a_SOL_puppet
					country_event = { id = solarempire.15 days = 1 }
				}

				if = {
					limit = {
						has_global_flag = the_crystal_war
						FROM = { original_tag = EQS  }
						original_tag = CRY
					}
					news_event = { id = news.43 days = 1}
					clr_global_flag = the_crystal_war
					remove_opinion_modifier = { target = FROM modifier = mortal_enemies }
					FROM = { remove_opinion_modifier = { target = ROOT modifier = mortal_enemies } }
				}
				else_if = {
					limit = {
						FROM = { original_tag = EQS }
						tag = NLR
					}
					FROM = {
						kill_country_leader = yes
					}
					if = {
						limit = { country_exists = FROM }
						annex_country = { target = FROM }
					}
					country_event = { id = news.2041 days = 1 }
					country_event = { id = lunas.35 days = 1 random_hours = 4800 }#days to hours applied
				}

				if = {
					limit = {
						FROM = { tag = DED }
						NOT = {
							AND = {
								original_tag = ZAI
								OR = {
									has_cosmetic_tag = Terathopia
									has_cosmetic_tag = Terathopia_2
									has_cosmetic_tag = Terathopia_3
								}
							}
						}
					}
					annex_country = { target = FROM  }
					country_event = { id = deadempire.29 days = 1 }
				}

				else_if = {
					limit = {
						tag = HLR
						FROM = { tag = EWI }
					}
					country_event = { id = arcturian.50 days = 1 }
				}

				else_if = {
					limit = {
						tag = BRF
						FROM = { tag = GRW }
					}
					country_event = { id = brodfeld.21 days = 1 }
					if = {
						limit = {
							NOT = { has_global_flag = prywhen_civil_war_is_over }
						} 
						set_global_flag = GRW_won_first
					}
				}
				else_if = {
					limit = {
						tag = GRW
						FROM = { tag = BRF }
					}
					country_event = { id = prywhen.1 days = 1 }
					if = {
						limit = {
							NOT = { has_global_flag = prywhen_civil_war_is_over }
						} 
						set_global_flag = BRF_won_first
					}
				}

				else_if = {
					limit = {
						tag = LSC
						OR = {
							AND = {
								NOT = { country_exists = LNS }
								FROM = { tag = LSM }
							}
							AND = {
								NOT = { country_exists = LSM }
								FROM = { tag = LNS }
							}
						}
					}
					country_event = { id = longsword.31 days = 1 }
				}
				else_if = {
					limit = {
						tag = LSM
						OR = {
							AND = {
								NOT = { country_exists = LNS }
								FROM = { tag = LSC }
							}
							AND = {
								NOT = { country_exists = LSC }
								FROM = { tag = LNS }
							}
						}
					}
					country_event = { id = longsword.57 days = 1 }
				}
				else_if = {
					limit = {
						tag = LNS
						OR = {
							AND = {
								NOT = { country_exists = LSM }
								FROM = { tag = LSC }
							}
							AND = {
								NOT = { country_exists = LSC }
								FROM = { tag = LSM }
							}
						}
					}
					country_event = { id = longsword.78 days = 1 }
				}
				else_if = {
					limit = {
						tag = JER
						has_completed_focus = JER_state_of_aquileia
						OR = {
							AND = {
								OR = {
									NOT = {country_exists = JRR }
									JRR = { is_subject_of = JER }
								}
								OR = {
									NOT = { country_exists = VIN }
									VIN = { is_subject_of = JER }
								}
								OR = {
									NOT = { country_exists = JFT }
									JFT = { is_subject_of = JER }
								}
								FROM = { tag = JEB }
							}
							AND = {
								OR = {
									NOT = {country_exists = JEB }
									JEB = { is_subject_of = JER }
								}
								OR = {
									NOT = { country_exists = VIN }
									VIN = { is_subject_of = JER }
								}
								OR = {
									NOT = { country_exists = JFT }
									JFT = { is_subject_of = JER }
								}
								FROM = { tag = JRR }
							}
							AND = {
								OR = {
									NOT = {country_exists = JEB }
									JEB = { is_subject_of = JER }
								}
								OR = {
									NOT = { country_exists = JRR }
									JRR = { is_subject_of = JER }
								}
								OR = {
									NOT = { country_exists = JFT }
									JFT = { is_subject_of = JER }
								}
								FROM = { tag = VIN }
							}
							AND = {
								OR = {
									NOT = { country_exists = JEB }
									JEB = { is_subject_of = JER }
								}
								OR = {
									NOT = { country_exists = JRR }
									JRR = { is_subject_of = JER }
								}
								OR = {
									NOT = { country_exists = VIN }
									VIN = { is_subject_of = JER }
								}
								FROM = { tag = JFT }
							}
						}
					}
					country_event = { id = aquileia.48 days = 1 }
				}
                if = {
					limit = {
						tag = JER
						has_completed_focus = JER_fight_for_freedom
						OR = {
							AND = {
                                OR = {
								    NOT = {country_exists = JRR }
									JRR = { is_subject_of = JER }
                                }
                                OR = {
								    NOT = { country_exists = VIN }
									VIN = { is_subject_of = JER }
                                }
                                OR = {
								    NOT = { country_exists = JFT }
									JFT = { is_subject_of = JER }
                                }
								FROM = { tag = JEB }
							}
							AND = {
                                OR = {
								    NOT = {country_exists = JEB }
									JEB = { is_subject_of = JER }
                                }
                                OR = {
								    NOT = { country_exists = VIN }
									VIN = { is_subject_of = JER }
                                }
                                OR = {
								    NOT = { country_exists = JFT }
									JFT = { is_subject_of = JER }
                                }
								FROM = { tag = JRR }
							}
							AND = {
                                OR = {
								    NOT = {country_exists = JEB }
									JEB = { is_subject_of = JER }
                                }
                                OR = {
								    NOT = { country_exists = JRR }
									JRR = { is_subject_of = JER }
                                }
                                OR = {
								    NOT = { country_exists = JFT }
									JFT = { is_subject_of = JER }
                                }
								FROM = { tag = VIN }
							}
							AND = {
                                OR = {
								    NOT = { country_exists = JEB }
									JEB = { is_subject_of = JER }
                                }
                                OR = {
								    NOT = { country_exists = JRR }
									JRR = { is_subject_of = JER }
                                }
                                OR = {
								    NOT = { country_exists = VIN }
									VIN = { is_subject_of = JER }
                                }
								FROM = { tag = JFT }
							}
						}
					}
					country_event = { id = aquileia.18 days = 1 }
				}
				if = {
					limit = {
						has_opinion_modifier = NIM_atrocities
						FROM = { tag = NIM }
					}
					FROM = {
						every_other_country = {
							remove_opinion_modifier = { target = FROM modifier = NIM_atrocities }
						}
					}
				}
				if = {
					limit = {
						FROM = {
							original_tag = YAL
							YAL_emperor_grover_ii = { is_unit_leader = yes }
							NOT = {
								has_country_leader = {
									ruling_only = yes
									character = YAL_emperor_grover_ii
								}
							}
						}
					}
					FROM = {
						YAL_emperor_grover_ii = {
							remove_unit_leader_role = yes
							if = {
								limit = { is_advisor = yes }

								remove_advisor_role = { slot = army_chief }
							}
						}
						remove_opinion_modifier = {
							target = NIM
							modifier = mortal_enemies
						}
						NIM = {
							remove_opinion_modifier = {
								target = PREV
								modifier = mortal_enemies
							}
						}
					}
				}
				if = {
					limit = {
						OR = {
							AND = {
								ROOT = { tag = SRS }
								FROM = { tag = NTR }
							}
							AND = {
								has_global_flag = SRS_has_triggered_civilwar_in_NTR
								ROOT = { tag = NTR }
								FROM = { original_tag = NTR }
							}
						}
					}
					SRS = {
						country_event = { id = socrep_grif.83 hours = 12 }
					}
				}
				if = {
					limit = {
						has_country_flag = SRS_has_triggered_civilwar_in_themselves
						ROOT = { tag = SRS }
						FROM = { original_tag = SRS }
					}
					SRS = {
						country_event = { id = socrep_grif.91 hours = 2 }
					}
				}

				# Delete tribal templates
				if = {
					limit = {
						OR = {
							tag = CES
							tag = JUN
							tag = NMS
						}
						FROM = {
							OR = {
								tag = CES
								tag = JUN
								tag = NMS
								tag = BAL
							}
						}
					}
					# more triggers in event
					country_event = { id = civwar.24 days = 1 random_hours = 48 }
				}

				if = {
					limit = {
						has_global_flag = equestrian_civil_war
						NOT = { has_global_flag = equestrian_civil_war_ended }
						FROM = {
							OR = {
								original_tag = EQS
								tag = NLR
							}
						}
					}
					set_global_flag = equestrian_civil_war_ended
				}

				if = {
					limit = {
						has_global_flag = the_war
						NOT = { has_global_flag = the_war_ended }
						FROM = {
							tag = CHN
						}
					}
					set_global_flag = the_war_ended
				}

				if = {
					limit = {
						NOT = { has_global_flag = prywhen_civil_war_is_over }
						FROM = {
							OR = {
								tag = GRW
								tag = BRF
							}
						}
					}
					set_global_flag = prywhen_civil_war_is_over
				}

				if = {
					limit = {
						ROOT = {
							OR = {
								has_country_flag = north_zebrican_war_participant
								AND = {
									original_tag = BAT
									has_global_flag = BAT_won_civil_war
								}
							}
						}
						FROM = {
							original_tag = HIP
							NOT = {
								has_country_flag = BAT_HIP_defeated
							}
						}
					}
					set_country_flag = BAT_HIP_defeated
					clr_country_flag = north_zebrican_war_participant
				}
				if = {
					limit = {
						ROOT = {
							original_tag = HIP
							NOT = {
								has_country_flag = BAT_HIP_defeated
							}
						}
						FROM = {
							OR = {
								AND = {
									OR = {
										tag = BAT
										tag = CTH
										tag = TBK
										tag = WNG
									}
									has_country_flag = north_zebrican_war_participant
								}
								tag = HIE
							}
						}
						NOT = {
							ROOT = {
								any_enemy_country = {
									is_subject = no
									has_country_flag = north_zebrican_war_participant
									has_capitulated = no
								}
							}
						}
					}
					set_country_flag = HIP_won_north_zebrican_war
					ROOT = {clr_country_flag = north_zebrican_war_participant}
					FROM = {clr_country_flag = north_zebrican_war_participant}
					mark_focus_tree_layout_dirty = yes
				}
				else_if = {
					limit = {
						ROOT = {
							original_tag = HIP
							has_completed_focus = HIP_strike_first
						}
						FROM = {
							OR = {
								original_tag = TBK
								original_tag = ZAR
								original_tag = BAT
								original_tag = WAR
							}
						}
						OR = {
							FROM = {
								owns_state = 712
							}
							ROOT = {
								owns_state = 712
							}
						}
					}
					set_country_flag = HIP_won_north_zebrican_war
					mark_focus_tree_layout_dirty = yes
				}
				if = {
					limit = {
						FROM = {
							original_tag = BAT
						}
						NOT = {
							has_country_flag = BAT_commonwealth_established
							has_country_flag = BAT_national_catastrophe
						}
					}
					BAT = {
						every_core_state = {
							limit = {
								NOT = {
									state = 689
									state = 690
									state = 691
									state = 712
									state = 713
									state = 815
								}
							}
							remove_core_of = BAT
						}
					}
				}
				if = {
					limit = {
						original_tag = BAT
						NOT = {
							has_country_flag = BAT_commonwealth_established
							has_country_flag = BAT_national_catastrophe
						}
						NOT = {
							WAR = {
								exists = yes
								is_subject = no
							}
							ZAR = {
								exists = yes
								is_subject = no
							}
							TBK = {
								exists = yes
								is_subject = no
							}
						}
						NOT = {
						    has_global_flag = BAT_won_civil_war
						}
						OR = {
						    has_country_flag = total_war
							has_country_flag = partial_war
							has_country_flag = permenant_total_war
						    has_country_flag = HIE_BAT_alliance
						}
						FROM = {
						    original_tag = HIP
						}
					}
					if = {
						limit = {
							is_in_faction_with = CTH
							CTH = {
								has_country_leader = {
									character = CTH_zalathel_zarca
									ruling_only = yes
								}
							}
						}
						CTH = {
							country_event = {
								id = colthage_other.211
							}
						}
					}
					else = {
						country_event = bat.81
					}
				}
				if = {
					limit = {
						original_tag = BAT
						NOT = {
							has_country_flag = BAT_commonwealth_established
							has_country_flag = BAT_national_catastrophe
						}
						OR = {
							WAR = {
								exists = yes
								is_subject = no
							}
							ZAR = {
								exists = yes
								is_subject = no
							}
							TBK = {
								exists = yes
								is_subject = no
							}
						}
						NOT = {
						    has_global_flag = BAT_won_civil_war
						}
						OR = {
						    has_country_flag = total_war
							has_country_flag = partial_war
							has_country_flag = permenant_total_war
						    has_country_flag = HIE_BAT_alliance
						}
						FROM = {
						    original_tag = HIP
						}
					}
					country_event = {
						id = bat.79
					}
				}
				if = {
					limit = {
						original_tag = BAT
						NOT = {
							has_country_flag = BAT_commonwealth_established
							has_country_flag = BAT_national_catastrophe
						}
						has_global_flag = BAT_won_civil_war
						FROM = {
						    original_tag = HIP
						}
						NOT = {
							WAR = {
								exists = yes
								is_subject = no
							}
							ZAR = {
								exists = yes
								is_subject = no
							}
							TBK = {
								exists = yes
								is_subject = no
							}
						}
					}
					country_event = {
						id = bat.130
					}
				}
				if = {
					limit = {
						original_tag = BAT
						NOT = {
							has_country_flag = BAT_commonwealth_established
							has_country_flag = BAT_national_catastrophe
						}
						has_global_flag = BAT_won_civil_war
						FROM = {
						    original_tag = HIP
						}
						NOT = {
							WAR = {
								exists = yes
								is_subject = no
							}
							ZAR = {
								exists = yes
								is_subject = no
							}
							TBK = {
								exists = yes
								is_subject = no
							}
						}
					}
					country_event = {
						id = bat.79
					}
				}
				if = {
					limit = {
						original_tag = BAT
						NOT = {
							has_country_flag = BAT_commonwealth_established
							has_country_flag = BAT_national_catastrophe
						}
						has_country_flag = BAT_HIP_defeated
						NOT = {
							has_global_flag = BAT_won_civil_war
						}
						OR = {
							AND = {
								FROM = {
									original_tag = TBK
								}
								WAR = {
									OR = {
										exists = no
										is_subject_of = BAT
									}
								}
								ZAR = {
									OR = {
										exists = no
										is_subject_of = BAT
									}
								}
							}
							AND = {
								FROM = {
									original_tag = WAR
								}
								TBK = {
									OR = {
										exists = no
										is_subject_of = BAT
									}
								}
								ZAR = {
									OR = {
										exists = no
										is_subject_of = BAT
									}
								}
							}
							AND = {
								FROM = {
									original_tag = WAR
								}
								TBK = {
									OR = {
										exists = no
										is_subject_of = BAT
									}
								}
								ZAR = {
									OR = {
										exists = no
										is_subject_of = BAT
									}
								}
							}
							AND = {
								FROM = {
									original_tag = CTH
									has_country_flag = CTH_war_with_bats
								}
								TBK = {
									OR = {
										exists = no
										is_subject_of = BAT
									}
								}
								ZAR = {
									OR = {
										exists = no
										is_subject_of = BAT
									}
								}
								has_country_flag = BAT_HIP_defeated
							}
						}
					}
					country_event = bat.81
				}
				if = {
					limit = {
						original_tag = BAT
						NOT = {
							has_country_flag = BAT_commonwealth_established
							has_country_flag = BAT_national_catastrophe
						}
						has_country_flag = BAT_HIP_defeated
						has_global_flag = BAT_won_civil_war
						OR = {
							AND = {
								FROM = {
									original_tag = TBK
								}
								WAR = {
									OR = {
										exists = no
										is_subject_of = BAT
									}
								}
								ZAR = {
									OR = {
										exists = no
										is_subject_of = BAT
									}
								}
							}
							AND = {
								FROM = {
									original_tag = WAR
								}
								TBK = {
									OR = {
										exists = no
										is_subject_of = BAT
										is_in_faction_with = NLR
									}
								}
								ZAR = {
									OR = {
										exists = no
										is_subject_of = BAT
									}
								}
							}
							AND = {
								FROM = {
									original_tag = WAR
								}
								TBK = {
									OR = {
										exists = no
										is_subject_of = BAT
										is_in_faction_with = NLR
									}
								}
								ZAR = {
									OR = {
										exists = no
										is_subject_of = BAT
									}
								}
							}
						}
					}
					country_event = bat.130
				}
				if = {
					limit = {
					    country_exists = BAT
						ROOT = {
							tag = NLR
						}
						FROM = {
							original_tag = EQS
						}
					}
					if = {
						limit = {
							BAT = {
								NOT = {has_country_flag = BAT_national_catastrophe}
							}
						}
						BAT = {
							country_event = bat.18
						}
					}
				}
				if = {
					limit = {
						ROOT = {
							tag = BAT
						}
						FROM = {
							tag = WAR
						}
					}
					set_country_flag = { flag = bypass_annex_compliance days = 1 value = 1 }
					annex_country = { target = FROM }
				}
				if = {
					limit = {
						original_tag = BAT
						has_country_flag = BAT_triarchy_formed
						NOT = {
							has_country_flag = BAT_socialist_victory
							has_country_flag = BAT_harmonist_victory
							has_country_flag = BAT_neutrality_victory
							has_country_flag = BAT_supremacy_victory
							has_country_flag = BAT_stirling_victory
						}
						FROM = {
						    has_country_flag = BAT_took_BAT_states
						}
					}
					country_event = {
						id = bat.156
					}
				}
				if = {
					limit = {
						original_tag = HIE
						has_country_flag = HIE_BAT_alliance
						NOT = {
						    has_global_flag = BAT_won_civil_war
						}
						is_in_faction_with = BAT
						FROM = {
						    original_tag = HIP
						}
					}
					country_event = {
						id = hippone_sekrit.38
					}
				}
				if = {
					limit = {
						original_tag = CVA
						NOT = {
							country_exists = CTC
							country_exists = CTB
						}
						NOT = {
							has_country_flag = CVA_zeirutid_assassinated
						}
						FROM = {
							tag = CTA
						}
					}
					country_event = {
						id = zebra_zapata.3
					}
				}
				if = {
					limit = {
						original_tag = CVA
						NOT = {
							has_country_flag = CVA_zeirutid_assassinated
						}
						FROM = {
							tag = CTC
						}
					}
					country_event = {
						id = zebra_zapata.4
					}
				}
				if = {
					limit = {
						original_tag = CVA
						has_country_flag = CVA_zeirutid_assassinated
						FROM = {
						    tag = CTC
						}
					}
					country_event = {
						id = zebra_zapata.5
					}
				}
				if = {
					limit = {
						original_tag = WIN
						has_country_flag = WIN_bean_takeover
						FROM = {
							tag = HIP
						}
					}
					country_event = {
						id = legation.79
					}
				}
				if = {
					limit = {
						original_tag = WIN
						has_country_flag = WIN_WNG_takeover
						FROM = {
							tag = HIP
						}
					}
					country_event = {
						id = legation.99
					}
				}
				if = {
					limit = {
						original_tag = WIN
						has_country_flag = WIN_BAT_takeover
						FROM = {
							tag = HIP
						}
					}
					country_event = {
						id = legation.108
					}
				}
				if = {
					limit = {
						has_global_flag = CTH_third_civil_war
					}
					if = {
						limit = {
							original_tag = TRO
							OR = {
								AND = {
									NOT = {
										country_exists = HIE
									}
									FROM = {
										tag = MZN
									}
								}
								AND = {
									NOT = {
										country_exists = MZN
									}
									FROM = {
										tag = HIE
									}
								}
							}
							CVA = {
							    OR = {
								    exists = no
									is_subject_of = ROOT
								}
							}
						}
						if = {
							limit = { country_exists = FROM }
							set_country_flag = { flag = bypass_annex_compliance days = 1 value = 1 }
							annex_country = { target = FROM }
						}
						country_event = {
							id = trotkart_colthage.8 hours = 1 #For end of civil war event when added
						}
					}
					if = {
						limit = {
							original_tag = TRO
							OR = {
								AND = {
									NOT = {
										country_exists = HIE
									}
									FROM = {
										tag = MZN
									}
								}
								AND = {
									NOT = {
										country_exists = MZN
									}
									FROM = {
										tag = HIE
									}
								}
							}
							CVA = {
							    OR = {
								    exists = yes
									NOT = {
										is_subject_of = ROOT
									}
								}
							}
						}
						if = {
							limit = { country_exists = FROM }
							set_country_flag = { flag = bypass_annex_compliance days = 1 value = 1 }
							annex_country = { target = FROM }
						}
						country_event = {
							id = trotkart_colthage.29 hours = 1 #For end of civil war event when added
						}
					}
					if = {
						limit = {
							original_tag = TRO
							NOT = {
								country_exists = HIE
								country_exists = MZN
							}
							FROM = {
								tag = CVA
							}
						}
						if = {
							limit = { country_exists = FROM }
							set_country_flag = { flag = bypass_annex_compliance days = 1 value = 1 }
							annex_country = { target = FROM }
						}
						country_event = {
							id = trotkart_colthage.8 hours = 1 #For end of civil war event when added
						}
					}
					if = {
						limit = {
							tag = MZN
							OR = {
								AND = {
									NOT = {
										country_exists = HIE
									}
									FROM = {
										tag = TRO
									}
								}
								AND = {
									NOT = {
										country_exists = TRO
									}
									FROM = {
										tag = HIE
									}
								}
							}
						}
						if = {
							limit = { country_exists = FROM }
							set_country_flag = { flag = bypass_annex_compliance days = 1 value = 1 }
							annex_country = { target = FROM }
						}
						country_event = {
							id = colthage_monzano_cw_untriggered.1 hours = 1 #For end of civil war event when added
						}
					}
					if = {
						limit = {
							original_tag = HIE
							OR = {
								AND = {
									NOT = {
										country_exists = MZN
									}
									FROM = {
										tag = TRO
									}
								}
								AND = {
									NOT = {
										country_exists = TRO
									}
									FROM = {
										tag = MZN
									}
								}
							}
						}
						if = {
							limit = { country_exists = FROM }
							set_country_flag = { flag = bypass_annex_compliance days = 1 value = 1 }
							annex_country = { target = FROM }
						}
						country_event = {
							id = hippone_sekrit.12 hours = 1
						}
					}
				}
				if = {
					limit = {
						ROOT = {
							tag = ZAR
						}
						#This thing was just pointless I think. I hate NZ peace deals.
						#NOT = {
						#	country_exists = BAT
						#}
						FROM = {
							tag = BAT
						}
					}
					if = {
						limit = {
							country_exists = TBK
						}

						#ZAR beat Chiropterra with Tobuck, transfers states to it.
						if = {
							limit = {
								BAT = {
									exists = yes
									is_subject_of = ZAR
								}
							}
							TBK = {
								set_country_flag = { flag = bypass_annex_compliance days = 1 value = 1 }
								annex_country = {
									target = BAT
									transfer_troops = no
								}
							}
						}
						if = {
							limit = {
								ZAR = {
									any_owned_state = {
										is_core_of = BAT
									}
								}
							}
							every_owned_state = {
								if = {
									limit = {
										is_core_of = BAT
									}
									TBK = {
										transfer_state = PREV
									}
								}
							}
						}
					}
					else = {

						if = {
							limit = {
								BAT = {
									exists = yes
									is_subject_of = ZAR
								}
							}
							ZAR = {
								set_country_flag = { flag = bypass_annex_compliance days = 1 value = 1 }
								annex_country = {
									target = BAT
									transfer_troops = no
								}
							}
						}
						if = { # No effects
							limit = {
								OR = {
									ZAR = {
										has_country_flag = ZAR_wormy
									}
									BAT = {
										has_country_flag = BAT_national_catastrophe
									}
								}
							}
							#Nothing happens, ZAR is in worm path, or BAT came in for a revenge and died again. This will not release BAT.
						}

						else_if = {
							limit = {
								all_of_scopes = {
									array = ZAR_BAT_states
									owner = {
										tag = ZAR
									}
								}
							}
							#ZAR beat Chiropterra on it's own

							ZAR = {

								country_event = {
									id = zarantia.44
									days = 1
								}
							}
						}
						else_if = {
							limit = {
								any_of_scopes = {
									array = ZAR_BAT_states
									owner = {
										tag = HIP
									}
								}
							}
							#Foreign Intervention
							every_owned_state = {
								limit = {
									is_in_array = {
										array = ZAR.ZAR_BAT_states
										value = THIS
									}
								}
								transfer_state_to = HIP
							}

							country_event = {
								id = zarantia.445
								days = 1
							}
						}
					}
				}
				if = {
					limit = {
						ROOT = {
							tag = ZAR
						}
						NOT = {
							country_exists = TBK
							country_exists = BAT
						}
						any_owned_state = {
							is_core_of = BAT
						}
						FROM = {
							tag = TBK
						}
					}
					#Release BAT after killing Tobuck if Tobuck didn't release it by itself.

					country_event = {
						id = zarantia.444
						days = 1
					}

				}
				if = {
					limit = {
						ROOT = {
							tag = TBK
						}
						NOT = {
							country_exists = BAT
						}
						FROM = {
							tag = BAT
						}
					}
					if = {
						limit = {
							has_completed_focus = TBK_new_tobuck
							has_completed_focus = TBK_wallnut_start
						}
						country_event = { id = tobuck_wallnut.3 }
					}
					if = {
						limit = {
							has_completed_focus = TBK_new_tobuck
							has_completed_focus = TBK_baragzen_start
						}
						country_event = { id = tobuck_baragzen.5 }
						ZAR = {
							add_timed_idea = {
								idea = ZAR_timed_looting
								days = 365
							}
						}
					}
					if = {
						limit = {
							has_completed_focus = TBK_new_tobuck
							has_completed_focus = TBK_alesia_start
						}
						country_event = { id = tobuck_alesia.5 }
					}
					if = {
						limit = {
							has_completed_focus = TBK_vasile_start
						}
						country_event = { id = tobuck_vasile.42 }
						ZAR = {
							add_timed_idea = {
								idea = ZAR_timed_looting
								days = 365
							}
						}
					}
				}

				if = {
					limit = {
						original_tag = WIN
						has_country_flag = WIN_BAT_takeover
						FROM = {
							tag = HIP
						}
					}
					country_event = {
						id = legation.108
					}
				}

				FROM = {
					every_owned_state = {
						limit = {
							has_state_flag = eqs_bat_state
						}
						add_core_of = EQS
						clr_state_flag = eqs_bat_state
					}
				}
				if = {
					limit = {
						original_tag = WNG
						FROM = {
							original_tag = FRN
							exists = yes
							OR = {
								is_in_faction_with = ROOT
								is_subject_of = ROOT
							}
						}
					}
					every_owned_state = {
						limit = {
							is_core_of = JES
						}
						transfer_state_to = FROM
					}
				}
				every_owned_state = {
					limit = {
						has_state_flag = eqs_bat_state
					}
					add_core_of = EQS
					clr_state_flag = eqs_bat_state
				}
				if = {		#GRF STG peacedeal
					limit = {
						original_tag = GRF
						FROM = {
							original_tag = STG
						}
					}
					country_event = { id = griffons.143 days = 5 }
				}
				if = { # workaround to hopefully fix the weird GRF behavior
					limit = {
						original_tag = STG
						FROM = {
							original_tag = GRF
						}
						any_country_with_original_tag = {
							original_tag_to_check = GRF
							is_subject_of = ROOT
						}
					}
					random_country_with_original_tag = {
						original_tag_to_check = GRF
						limit = {
							is_subject_of = STG
						}
						country_event = { id = griffons.142 days = 5 }
					}
				}

				if = {
					limit = { # Dawnclaw Heresy (April Fools) got puppeted
						FROM = {
							original_tag = FAT
							has_cosmetic_tag = FAT_APRILFOOLS
							is_subject = yes
						}
					}
					FROM = {
						imperial_aprilfool_unhammer = yes # drops cosmetic tag, removes leaders and AF ideas
						imperial_aprilfool_postwar_disarray = yes # moderately reduces stability and war support (should not stay super high after such political upheaval)
						clr_country_flag = dawnclaw_heresy_focustree
						clr_country_flag = FLO_loans_blocked
						if = {
							limit = { overlord = { has_government = democratic } }
							load_focus_tree = fatass_democratic_focus
						}
						else_if = {
							limit = { overlord = { has_government = communism } }
							load_focus_tree = generic_griffon_focus # there doesn't seem to be a generic communist focus tree for FAT, aside from the one for being a Skynavia puppet, which according to comments in the Skynavian event code that loads it (socrep_grif.43) is bugged for the AI and can cause a crash. so we'll play it safe and load a generic griffon focus tree if it becomes a communist puppet
						}
						else_if = {
							limit = { overlord = { has_government = fascism } }
							load_focus_tree = fatass_suntail_empire_focus
						}
						else = {
							load_focus_tree = generic_griffon_focus # neutral FAT focus trees seem to involve characters who are presumably no longer around after the April Fools events, so we'll play it safe and load a generic griffon focus tree if it becomes a neutral puppet
						}
						set_party_name = { # remove cultists
							ideology = fascism
							long_name = FAT_fascism_party
							name = FAT_fascism_party_long
						}
					}
				}
				if = {
					limit = { # Imperium (April Fools) got puppeted
						FROM = {
							original_tag = GRI
							has_cosmetic_tag = GRI_APRILFOOLS
							is_subject = yes
						}
					}
					FROM = {
						imperial_aprilfool_unhammer = yes # drops cosmetic tag, removes leaders and AF ideas
						imperial_aprilfool_postwar_disarray = yes # moderately reduces stability and war support (should not stay at super high after such political upheaval)
						clr_country_flag = FLO_loans_blocked
						load_focus_tree = generic_griffon_focus # play it safe and load a generic griffon focus tree
						# Give parties back their non-Imperium names
						set_party_name = {
							ideology = democratic
							long_name = GRI_democratic_party
							name = GRI_democratic_party_long
						}
						set_party_name = {
							ideology = communism
							long_name = GRI_communism_party
							name = GRI_communism_party_long
						}
						set_party_name = {
							ideology = fascism
							long_name = GRI_junta
							name = GRI_junta_long
						}
						set_party_name = {
							ideology = neutrality
							long_name = GRI_neutrality_party
							name = GRI_neutrality_party_long
						}
					}
				}



				# remove demilitarized flag if previous overlord no longer exists, has become a subject or if country gains a new overlord
				# done to prevent countries from ending up with demilitarized puppets that don't want any				
				FROM = {
					if = {
						limit = {
							FROM = {
								has_country_flag = demilitarized
							}
						}
						if = {
							limit = {
								OR = {
									if = {
										limit = {
											is_subject = yes
										}
										overlord = {
											NOT = {
												tag = FROM.overlord_before_pc
											}
										}
									}
									is_subject = no
									var:overlord_before_pc = {
										OR = {
											exists = no
											is_subject = yes
										}
									}
								}
							}
							clr_country_flag = demilitarized
							log = "[GetDateText]: ROOT: [Root.GetName] FROM: [From.GetName] demilitarized flag cleared"
							set_temp_variable = {
								current_overlord = overlord
							}
							# need to end puppet before puppeting anew or it will take lower possible autonomy instead of default
							end_puppet_this = yes
							var:current_overlord = {
								puppet = FROM
							}
						}
						clear_variable = overlord_before_pc
					}
				}
				# if a country is an AI puppet with only one state and surrounded by another country, annex them to reduce bordergore
				FROM = { country_event = { id = utility.10 hours = 1 } }

				update_global_arrays_all = yes
			}
		}
	}
}
