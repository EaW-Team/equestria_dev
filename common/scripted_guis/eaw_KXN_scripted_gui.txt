scripted_gui = {
	KXN_Nirik_Kirin_Toggle_Handle_SGUI = {
		context_type = player_context
		parent_window_name = "countrypoliticsview"

		visible = {
			ROOT = {
				tag = KXN
				is_ai = no
			}
		}

		window_name = "KXN_Nirik_Kirin_Toggle_Handle"
		
		effects = {
			KXN_Kirin_Toggle_Handle_click = {
				if = {
					limit = {
						has_country_flag = KXN_Nirik_Kirin_Toggle_Open
					}
					clr_country_flag = KXN_Nirik_Kirin_Toggle_Open
				}
				else = {
					set_country_flag = KXN_Nirik_Kirin_Toggle_Open
				}
			}
		}

		triggers = {
			KXNHarvestBackground_visible = {
				has_country_flag = KXN_Nirik_Kirin_Toggle_Open
			}
			KXN_Kirin_Toggle_Close_visible = {
				has_country_flag = KXN_Nirik_Kirin_Toggle_Open
			}
			KXN_Kirin_Toggle_Open_visible = {
				NOT = { has_country_flag = KXN_Nirik_Kirin_Toggle_Open }
			}
		}
	}
	
	KXN_Nirik_Kirin_Toggle_SGUI = {
		context_type = player_context
		parent_window_name = "countrypoliticsview"

		visible = {
			ROOT = {
				tag = KXN
				is_ai = no
				has_country_flag = KXN_Nirik_Kirin_Toggle_Open
			}
		}

		window_name = "KXN_Nirik_Kirin_Toggle_Window"

		triggers = {
			KXNKirNirUsesCounter_visible = {
				check_variable = { KXN.KXN_Nirik_Counter_Var < 1 }
			}
			KXN_Nirik_Glow_visible = {
				check_variable = { KXN.KXN_Nirik_Counter_Var > 0 }
			}
			KXN_Nirik_Pulsar_visible = {
				check_variable = { KXN.KXN_Nirik_Counter_Var > 0 }
			}
			KXN_Nirik_Counter_visible = {
				check_variable = { KXN.KXN_Nirik_Counter_Var > 0 }
			}
			KXN_Nirik_Counter_Progress_Bar_visible = {
				check_variable = { KXN.KXN_Nirik_Counter_Var > 0 }
			}
			KXN_Kirin_Button_visible = {
				check_variable = { KXN.KXN_Nirik_Counter_Var < 1 }
				check_variable = { KXN.KXN_Kirin_Countdown_Var < 1 }
			}
			KXN_Kirin_Counter_visible = {
				check_variable = { KXN.KXN_Nirik_Counter_Var < 1 }
				check_variable = { KXN.KXN_Kirin_Countdown_Var > 0 }
			}
			KXN_Kirin_Counter_Progress_Bar_visible = {
				check_variable = { KXN.KXN_Nirik_Counter_Var < 1 }
				check_variable = { KXN.KXN_Kirin_Countdown_Var > 0 }
			}
			KXN_Kirin_Icon_visible = {
				check_variable = { KXN.KXN_Nirik_Counter_Var < 1 }
				check_variable = { KXN.KXN_Kirin_Countdown_Var > 0 }
			}
			KXN_Kirin_Icon_click_enabled = {
				always = no ## Grey-out
			}
			KXN_Kirin_Button_click_enabled = {
				check_variable = { var = command_power value = 5 compare = greater_than_or_equals }
				check_variable = { var = KXN_KirNir_Uses_Var value = 1 compare = greater_than_or_equals }
			}
		}

		properties = {
			KXN_Kirin_Counter_Progress_Bar = {
				frame = KXN.KXN_Kirin_Countdown_Prog_Var
			}
			KXN_Nirik_Counter_Progress_Bar = {
				frame = KXN.KXN_Nirik_Counter_Prog_Var
			}
			KXNHarvestProgBar = {
				frame = KXN.KXNHarvestProgBar_Var
			}
			KXNHarvestCasualties = {
				frame = 0
			}
		}

		effects = {
			KXN_Kirin_Button_click = {
				set_variable = { var = KXN_Nirik_Counter_Var value = KXN_Nirik_Counter_Days }
				set_variable = { var = KXN_Kirin_Countdown_Var value = KXN_Kirin_Countdown_Days }
				set_variable = { KXN_Nirik_Counter_Prog_Var = 100 }
				add_command_power = -5
				subtract_from_variable = { KXN.KXN_KirNir_Uses_Var = 1 }
				add_dynamic_modifier = { modifier = KXN_Nirik_Storm days = KXN.KXN_Nirik_Counter_Days }
				add_country_leader_trait = nirik_fury
				if = {
					limit = { }
					set_technology = {
						popup = no
						KXN_Super_Valiants = 1
					}
					KXN_REFRESH_VALIANTS_EFFECT = yes
				}
				KXN_SET_NIRIK_PORTRAITS_EFFECT = yes
				country_event = { id = lan_kir_utility.1 days = KXN.KXN_Nirik_Counter_Days }
			}
		}
	}
	
	KXN_City_Fall_SGUI = {
		context_type = state_mapicon
		window_name = "KXN_City_Fall_Window"
		visible = {
			ROOT = {
				tag = KXN
				is_ai = no
			}
		}
		dirty = KXN.KXN_City_Fall_Var
		mapicon_targets = { target_array = KXN.City_Fall_Target_Array }

		effects = {
			KXN_CF_OCCUPY_BUTTON_click = {
				THIS = {
					KXN_OCCUPY_STATE_EFFECT = yes
					remove_from_array = { KXN.City_Fall_Target_Array = THIS }
					set_state_flag = { flag = KXN_STATE_FALLEN_FLAG days = 365 value = 1 }
					add_to_variable = { KXN.KXN_City_Fall_Var = 1 }
				}
				ROOT = { add_to_variable = { KXN_City_Fall_Var = 1 } }
			}
			KXN_CF_PILLAGE_BUTTON_click = {
				THIS = {
					KXN_PILLAGE_STATE_EFFECT = yes
					remove_from_array = { KXN.City_Fall_Target_Array = THIS }
					set_state_flag = { flag = KXN_STATE_FALLEN_FLAG days = 365 value = 1 }
					add_to_variable = { KXN.KXN_City_Fall_Var = 1 }
				}
				ROOT = { add_to_variable = { KXN_City_Fall_Var = 1 } }
			}
			KXN_CF_BURN_BUTTON_click = {
				THIS = {
					KXN_BURN_STATE_EFFECT = yes
					remove_from_array = { KXN.City_Fall_Target_Array = THIS }
					set_state_flag = { flag = KXN_STATE_FALLEN_FLAG days = 365 value = 1 }
					add_to_variable = { KXN.KXN_City_Fall_Var = 1 }
				}
				ROOT = { add_to_variable = { KXN_City_Fall_Var = 1 } }
			}
			KXN_CF_TOGGLE_BUTTON_click = {
				THIS = {
					if = {
						limit = {
							has_state_flag = KXN_STATE_FALL_TOGGLED_FLAG
						}
						clr_state_flag = KXN_STATE_FALL_TOGGLED_FLAG
					}
					else = {
						set_state_flag = KXN_STATE_FALL_TOGGLED_FLAG
					}
					add_to_variable = { KXN.KXN_City_Fall_Var = 1 }
				}
				ROOT = { add_to_variable = { KXN_City_Fall_Var = 1 } }
			}
		}

		triggers = {
			KXN_City_Fall_Title_visible = { has_state_flag = KXN_STATE_FALL_TOGGLED_FLAG }
			KXN_City_Fall_BG_visible = { has_state_flag = KXN_STATE_FALL_TOGGLED_FLAG }
			KXN_CF_OCCUPY_BUTTON_TITLE_visible = { has_state_flag = KXN_STATE_FALL_TOGGLED_FLAG }
			KXN_CF_OCCUPY_BUTTON_visible = { has_state_flag = KXN_STATE_FALL_TOGGLED_FLAG }
			KXN_CF_PILLAGE_RESOURCES_TITLE_visible = { has_state_flag = KXN_STATE_FALL_TOGGLED_FLAG }
			KXN_CF_PILLAGE_BUTTON_TITLE_visible = { has_state_flag = KXN_STATE_FALL_TOGGLED_FLAG }
			KXN_CF_PILLAGE_BUTTON_visible = { has_state_flag = KXN_STATE_FALL_TOGGLED_FLAG }
			KXN_CF_BURN_BUILDINGS_TITLE_visible = { has_state_flag = KXN_STATE_FALL_TOGGLED_FLAG }
			KXN_CF_BURN_BUTTON_TITLE_visible = { has_state_flag = KXN_STATE_FALL_TOGGLED_FLAG }
			KXN_CF_BURN_BUTTON_visible = { has_state_flag = KXN_STATE_FALL_TOGGLED_FLAG }
			### DEBUG ###
			KXN_BUG_WARNING_OVERLAY_visible = { always = no }
			KXN_BUG_WARNING_OVERLAY_TEXT_visible = { always = no }
		}
	}
	
	KXN_Conquest_Decision_Image_Desc = {
		context_type = decision_category
		parent_window_token = decision_tab

		visible = { always = yes }

		window_name = "KXN_Conquest_SGUI"
	}
}