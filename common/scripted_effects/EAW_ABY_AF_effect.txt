ABY_AF_AKL_calculate_mils_per_nation = {
	set_variable = { ABY_AF_AKL_mils_fund_per_nation = ABY_AF_AKL_mils_fund }
	set_variable = { ABY_AF_AKL_nation_count = 0 }
	for_each_scope_loop = {
		array = global.anti_kattail_league_array
		add_to_variable = { ABY.ABY_AF_AKL_nation_count = 1 }
	}
	divide_variable = { ABY_AF_AKL_mils_fund_per_nation = ABY_AF_AKL_nation_count }
	round_variable = ABY_AF_AKL_mils_fund_per_nation
	clamp_variable = { var = ABY_AF_AKL_mils_fund_per_nation min = 1 max = 1000 }
}

ABY_AF_AKL_upgrade_offense_idea = {
	if = {
		limit = { has_idea = ABY_AF_katzen_offense_training_1 }
		swap_ideas = { remove_idea = ABY_AF_katzen_offense_training_1 add_idea = ABY_AF_katzen_offense_training_2 }
	}
	else_if = {
		limit = { has_idea = ABY_AF_katzen_offense_training_2 }
		swap_ideas = { remove_idea = ABY_AF_katzen_offense_training_2 add_idea = ABY_AF_katzen_offense_training_3 }
	}
	else_if = {
		limit = { has_idea = ABY_AF_katzen_offense_training_3 }
		swap_ideas = { remove_idea = ABY_AF_katzen_offense_training_3 add_idea = ABY_AF_katzen_offense_training_4 }
	}
}

ABY_AF_AKL_upgrade_defense_idea = {
	if = {
		limit = { has_idea = ABY_AF_katzen_defense_training_1 }
		swap_ideas = { remove_idea = ABY_AF_katzen_defense_training_1 add_idea = ABY_AF_katzen_defense_training_2 }
	}
	else_if = {
		limit = { has_idea = ABY_AF_katzen_defense_training_2 }
		swap_ideas = { remove_idea = ABY_AF_katzen_defense_training_2 add_idea = ABY_AF_katzen_defense_training_3 }
	}
	else_if = {
		limit = { has_idea = ABY_AF_katzen_defense_training_3 }
		swap_ideas = { remove_idea = ABY_AF_katzen_defense_training_3 add_idea = ABY_AF_katzen_defense_training_4 }
	}
}

ABY_AF_calculate_katzen_tension = {
	set_variable = { aby_af_weekly_conquest_katzen_tension = aby_af_total_conquest_perc }
	subtract_from_variable = { aby_af_weekly_conquest_katzen_tension = aby_af_total_conquest_perc_previous_month }
	multiply_variable = { aby_af_weekly_conquest_katzen_tension = 1000 }
	clamp_variable = { var = aby_af_weekly_conquest_katzen_tension min = 0 max = 1000 }
	add_to_variable = { aby_af_katzen_tension = aby_af_weekly_conquest_katzen_tension }
}

ABY_AF_calculate_total_conquest_perc = {
	set_variable = { aby_af_total_conquest_perc_previous_month = aby_af_total_conquest_perc }
	set_variable = { aby_af_total_conquest_perc = 0 }
	add_to_variable = { aby_af_total_conquest_perc = aby_af_katzen_population_count }
	add_to_variable = { aby_af_total_conquest_perc = aby_af_katzen_factory_count }
	add_to_variable = { aby_af_total_conquest_perc = aby_af_world_perc_conquered }
	divide_variable = { aby_af_total_conquest_perc = 3 }
}

ABY_AF_calculate_population_perc = {
	set_variable = { aby_af_global_population_count = 0 }
	every_country = {
		add_to_variable = { ABY.aby_af_global_population_count = max_manpower_k }
	}
	set_variable = { aby_af_katzen_population_count = 0 }
	add_to_variable = { ABY.aby_af_katzen_population_count = max_manpower_k }

	divide_variable = { aby_af_katzen_population_count = aby_af_global_population_count }
}

ABY_AF_calculate_factories_perc = {
	set_variable = { aby_af_global_factory_count = 0 }
	every_country = {
		add_to_variable = { ABY.aby_af_global_factory_count = num_of_civilian_factories }
		add_to_variable = { ABY.aby_af_global_factory_count = num_of_military_factories }
		add_to_variable = { ABY.aby_af_global_factory_count = num_of_naval_factories }
	}
	set_variable = { aby_af_katzen_factory_count = 0 }
	add_to_variable = { ABY.aby_af_katzen_factory_count = num_of_civilian_factories }
	add_to_variable = { ABY.aby_af_katzen_factory_count = num_of_military_factories }
	add_to_variable = { ABY.aby_af_katzen_factory_count = num_of_naval_factories }

	divide_variable = { aby_af_katzen_factory_count = aby_af_global_factory_count }
}

ABY_AF_calculate_world_conquered_perc = {
	set_variable = { aby_af_world_perc_conquered = num_controlled_states  }
	divide_variable = { aby_af_world_perc_conquered = 1208 }
}

ABY_AF_add_to_conquest_timer = {
	custom_effect_tooltip = ABY_AF_add_to_conquest_timer_tt
	add_to_variable = { aby_af_kattail_conquest_timer = aby_af_conquest_timer_extra_days }
}

ABY_AF_clear_country_designation_flags = {
	if = {
		limit = { has_country_flag = ABY_AF_zebtropa_designation_arabian_coast }
		clr_country_flag = ABY_AF_zebtropa_designation_arabian_coast
	}
	else_if = {
		limit = { has_country_flag = ABY_AF_zebtropa_designation_maretonian_coast }
		clr_country_flag = ABY_AF_zebtropa_designation_maretonian_coast
	}
	else_if = {
		limit = { has_country_flag = ABY_AF_zebtropa_designation_riseia_coast }
		clr_country_flag = ABY_AF_zebtropa_designation_riseia_coast
	}
	else_if = {
		limit = { has_country_flag = ABY_AF_zebtropa_designation_north_arabian_coast }
		clr_country_flag = ABY_AF_zebtropa_designation_north_arabian_coast
	}
	else_if = {
		limit = { has_country_flag = ABY_AF_zebtropa_designation_yemane_coast }
		clr_country_flag = ABY_AF_zebtropa_designation_yemane_coast
	}
}

ABY_AF_clear_state_designation_flags = {
	if = {
		limit = { has_state_flag = aby_af_settlement_designation }
		clr_state_flag = aby_af_settlement_designation
	}
	else_if = {
		limit = { has_state_flag = aby_af_dredging_designation }
		clr_state_flag = aby_af_dredging_designation
	}
	else_if = {
		limit = { has_state_flag = aby_af_solar_designation }
		clr_state_flag = aby_af_solar_designation
	}
}

ABY_AF_form_UFS = {
	ABY = {
		if = {
			limit = {
				NOT = { has_idea = ABY_AF_grand_crusade_idea }
			}
			country_event = { id = katzen_AF.5000 days = 30 }
		}
		every_other_country = {
			every_character = {
				limit = {
					is_unit_leader = yes
				}
				set_nationality = UFS
			}
		}
	}
	UFS = {
		save_global_event_target_as = ABY_AF_world_federation
		declare_war_on = {
			target = ABY
			type = annex_everything
		}
		every_other_country = {
			limit = {
				is_ai = yes
				NOT = { tag = ABY }
				NOT = { has_idea = detached_country }
			}

			# every_character = {
			# 	limit = { is_advisor = yes }
			# 	set_nationality = UFS
			# }
			# every_unit_leader = { set_nationality = UFS }
			UFS = {
				if = {
					limit = { check_variable = { tmp_first_country > 0 } }
					# Have to check the technology that UFS doesn't have yet
					for_each_loop = {
						array = PREV.researched_techs
						value = tech_token

						if = {
							limit = {
								NOT = { is_in_array = { UFS.researched_techs = tech_token } }
							}
							meta_effect = {
								text = {
									set_technology = {
										[TECH] = 1
									}
								}
								TECH = "[?tech_token.GetTokenKey]"
							}
						}
					}

				} 
				else = {
					set_temp_variable = { tmp_first_country = 1 }
					inherit_technology = PREV
				}
				annex_country = {
					target = PREV
					transfer_troops = yes
				}
			}
		}
	}
	HIE ={
		every_unit_leader = { set_nationality = UFS }
	}
	event_target:ABY_AF_world_federation = {
		add_ideas = service_by_requirement
		add_ideas = tot_economic_mobilisation
		add_ideas = closed_economy
		set_research_slots = 5 #It's the entire world
		increase_society_development = yes
		increase_society_development = yes
		increase_society_development = yes
		decrease_poverty = yes
		decrease_poverty = yes
		decrease_poverty = yes
		every_state = { add_core_of = event_target:ABY_AF_world_federation }
		add_ideas = ABY_AF_world_federation_last_stand
		set_politics = {
			ruling_party = democratic
			elections_allowed = no
			long_name = "UFS_party_name"
			name = "UFS_party_name"
		}
		add_popularity = {
			ideology = democratic
			popularity = 1.00
		}
		load_focus_tree = BAR_empty_tree
		if = {
			limit = { is_in_faction = yes }
			leave_faction = yes
		}
	}
	set_global_flag = ABY_AF_musicflag2
	scoped_play_song = "Brad_Cypy-Battle_For_Supremacy"
}

#REWORKED COLLAPSE
#The Kaiser leaves and the Imperium goes to Pawtton
#The core lands remain under Katzen control
#All conquered states break away, either into their original countries OR into Katzen army groups
ABY_AF_partially_collapse_imperium = {
	ABY = {
		# every_controlled_state = { #Return occupied states to their rightful owners
		# 	limit = { NOT = { is_owned_by = ABY } }
		# 	transfer_state_to = owner
		# }
		every_controlled_state = {
			limit = { NOT = { is_core_of = ABY } }
			save_event_target_as = aby_af_katzen_collapse_state
			random_list = {
				35 = {} #Stay with Kaiser for now
				65 = { #Return to original country
					random_scope_in_array = {
						array = core_countries
						limit = {
							NOT = { tag = UFS }
							NOT = { tag = ABY }
							#event_target:aby_af_katzen_collapse_state = { is_core_of = PREV }
						}
						if = {
							limit = { NOT = { has_country_flag = aby_af_katzen_collapse_country_setup_done } }
							set_country_flag = aby_af_katzen_collapse_country_setup_done
							division_template = {
								name = "Liberation Forces"
								regiments = {
									infantry = { x = 0 y = 0 }
									infantry = { x = 0 y = 1 }
									infantry = { x = 0 y = 2 }
									infantry = { x = 1 y = 0 }
									infantry = { x = 1 y = 1 }
									infantry = { x = 1 y = 2 }
								}
								support = {
									engineer = { x = 0 y = 0 }
									recon = { x = 0 y = 0 }
									artillery = { x = 0 y = 0 }
								}
							}
						}
						event_target:aby_af_katzen_collapse_state = {
							transfer_state_to = PREV
							create_unit = {
								division = "division_template = \"Liberation Forces\" start_experience_factor = 0.25 start_equipment_factor = 1.0"
								count = 3
								owner = PREV
							}
						}
					}
				}
			}
		}
		every_country = {
			limit = {
				has_country_flag = aby_af_katzen_collapse_country_setup_done
				NOT = { has_war_with = ABY }
			}
			declare_war_on = {
				target = ABY
				type = annex_everything
			}
		}
	}
}

ABY_AF_start_katzen_civil_war = {
	ABY = {
		set_country_flag = ABY_AF_kaiser_left
		ABY_AF_kaiser_kattail = { retire = yes }
		set_cosmetic_tag = ABY_AF_katzenartig_imperium_failure_cosmetic
		set_country_flag = aby_af_katzen_civil_war_country
		declare_war_on = { target = SDL type = annex_everything }
		declare_war_on = { target = AES type = annex_everything }
		declare_war_on = { target = REE type = annex_everything }
		ABY_AF_Pawtton = {
			add_country_leader_role = {
				country_leader = {
					ideology = stratocracy
					expire = "1965.1.1.1"
				}
				promote_leader = yes
			}
		}
		ABY_AF_Growlzi = {
			set_nationality = SDL
			add_country_leader_role = {
				country_leader = {
					ideology = corporatocracy
					expire = "1965.1.1.1"
				}
				promote_leader = yes
			}
		}
		ABY_AF_Dietrich = {
			set_nationality = AES
			add_country_leader_role = {
				country_leader = {
					ideology = esotericism
					expire = "1965.1.1.1"
				}
				promote_leader = yes
			}
		}
		ABY_AF_Hell = {
			set_nationality = REE
			add_country_leader_role = {
				country_leader = {
					ideology = technocracy
					expire = "1965.1.1.1"
				}
				promote_leader = yes
			}
		}
		ABY_AF_Meolson = {
			set_nationality = ASS
			add_country_leader_role = {
				country_leader = {
					ideology = despotism
					expire = "1965.1.1.1"
				}
				promote_leader = yes
			}
		}
	}

	SDL = {
		set_cosmetic_tag = ABY_AF_katzen_growlzi_cw
		every_core_state = { limit = { is_controlled_by = ABY } transfer_state_to = SDL }
		set_country_flag = aby_af_katzen_civil_war_country
		declare_war_on = { target = ABY type = annex_everything }
		declare_war_on = { target = AES type = annex_everything }
		declare_war_on = { target = REE type = annex_everything }
		declare_war_on = { target = ASS type = annex_everything }
		set_politics = {
			ruling_party = fascism
			elections_allowed = no
		}
		add_popularity = {
			ideology = fascism
			popularity = 1.00
		}
	}

	AES = {
		set_cosmetic_tag = ABY_AF_katzen_dietrich_cw
		every_core_state = { limit = { is_controlled_by = ABY } transfer_state_to = AES }
		set_country_flag = aby_af_katzen_civil_war_country
		declare_war_on = { target = ABY type = annex_everything }
		declare_war_on = { target = SDL type = annex_everything }
		declare_war_on = { target = REE type = annex_everything }
		declare_war_on = { target = ASS type = annex_everything }
		set_politics = {
			ruling_party = fascism
			elections_allowed = no
		}
		add_popularity = {
			ideology = fascism
			popularity = 1.00
		}
	}
	KAR = { every_core_state = { limit = { is_controlled_by = ABY } transfer_state_to = AES add_core_of = AES } }
	MTO = { every_core_state = { limit = { is_controlled_by = ABY } transfer_state_to = AES add_core_of = AES } }
	IDT = { every_core_state = { limit = { is_controlled_by = ABY } transfer_state_to = AES add_core_of = AES } }

	REE = {
		set_cosmetic_tag = ABY_AF_katzen_hell_cw
		every_core_state = { limit = { is_controlled_by = ABY } transfer_state_to = REE }
		set_country_flag = aby_af_katzen_civil_war_country
		declare_war_on = { target = ABY type = annex_everything }
		declare_war_on = { target = AES type = annex_everything }
		declare_war_on = { target = SDL type = annex_everything }
		declare_war_on = { target = ASS type = annex_everything }
		set_politics = {
			ruling_party = neutrality
			elections_allowed = no
		}
		add_popularity = {
			ideology = neutrality
			popularity = 1.00
		}
	}
	HMR = { every_core_state = { limit = { is_controlled_by = ABY } transfer_state_to = REE add_core_of = REE } }
	OSQ = { every_core_state = { limit = { is_controlled_by = ABY } transfer_state_to = REE add_core_of = REE } }
	MTA = { every_core_state = { limit = { is_controlled_by = ABY } transfer_state_to = REE add_core_of = REE } }
	MAZ = { every_core_state = { limit = { is_controlled_by = ABY } transfer_state_to = REE add_core_of = REE } }
	MSS = { every_core_state = { limit = { is_controlled_by = ABY } transfer_state_to = REE add_core_of = REE } }

	ASS = {
		set_cosmetic_tag = ABY_AF_katzen_meolson_cw
		780 = { if = { limit = { is_controlled_by = ABY } transfer_state_to = ASS add_core_of = ASS } }
		784 = { if = { limit = { is_controlled_by = ABY } transfer_state_to = ASS add_core_of = ASS } }
		1201 = { if = { limit = { is_controlled_by = ABY } transfer_state_to = ASS add_core_of = ASS } }
		1200 = { if = { limit = { is_controlled_by = ABY } transfer_state_to = ASS add_core_of = ASS } }
		783 = { if = { limit = { is_controlled_by = ABY } transfer_state_to = ASS add_core_of = ASS } }
		1199 = { if = { limit = { is_controlled_by = ABY } transfer_state_to = ASS add_core_of = ASS } }
		set_country_flag = aby_af_katzen_civil_war_country
		declare_war_on = { target = ABY type = annex_everything }
		declare_war_on = { target = AES type = annex_everything }
		declare_war_on = { target = SDL type = annex_everything }
		declare_war_on = { target = REE type = annex_everything }
		set_politics = {
			ruling_party = neutrality
			elections_allowed = no
		}
		add_popularity = {
			ideology = neutrality
			popularity = 1.00
		}
	}

	ABY = {
		transfer_units_fraction = {
			target = REE
			stockpile_ratio = 0.15
			army_ratio = 0.1
			navy_ratio = 0.1
			air_ratio = 0.1
			keep_unit_leaders_trigger = {
				always = yes
			}
		}
		transfer_units_fraction = {
			target = AES
			stockpile_ratio = 0.1
			army_ratio = 0.15
			navy_ratio = 0.1
			air_ratio = 0.1
			keep_unit_leaders_trigger = {
				always = yes
			}
		}
		transfer_units_fraction = {
			target = SDL
			stockpile_ratio = 0.1
			army_ratio = 0.1
			navy_ratio = 0.1
			air_ratio = 0.2
			keep_unit_leaders_trigger = {
				always = yes
			}
		}
		transfer_units_fraction = {
			target = REE
			stockpile_ratio = 0.1
			army_ratio = 0.1
			navy_ratio = 0.3
			air_ratio = 0.05
			keep_unit_leaders_trigger = {
				always = yes
			}
		}
	}

	every_country = {
		limit = { has_country_flag = aby_af_katzen_civil_war_country }
		division_template = {
			name = "Katzenkaisergarde"

			regiments = {
				infantry = { x = 0 y = 0 }
				infantry = { x = 0 y = 1 }
				infantry = { x = 0 y = 2 }
				infantry = { x = 1 y = 0 }
				infantry = { x = 1 y = 1 }
				infantry = { x = 1 y = 2 }
				infantry = { x = 2 y = 0 }
				artillery_brigade = { x = 3 y = 0 }
				artillery_brigade = { x = 3 y = 1 }
			}
			support = {
				artillery = { x = 0 y = 0 }
				engineer = { x = 0 y = 1 }
			}
		}
		every_core_state = {
			limit = {
				ROOT = { has_full_control_of_state = PREV }
				impassable = no
			}
			random = {
				chance = 50
				create_unit = {
					division = "division_template = \"Katzenkaisergarde\" start_experience_factor = 0.25 start_equipment_factor = 1.0"
					count = 2
					owner = ROOT
				}
			}
		}
	}
}