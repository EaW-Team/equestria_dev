###########################
# POLITICAL UNREST EFFECTS
###########################

# Effect to get the total number of states susceptible to unrest modifiers
MGY_Unrest_GetNumberOfPossibleStates_effect = {
	set_variable = {
		MGY_OwnedStates_var = 0
	}
	hidden_effect = {
		every_owned_state = {
			limit = {
				impassable = no
			}
			owner = {
				add_to_variable = {
					MGY_OwnedStates_var = 1
				}
			}
		}
	}
}

#Effect to sum up the total unrest in the country
MGY_Unrest_GetTotalSum_effect = {
	set_variable = {
		MGY_TotalUnrest_var = 0
	}
	hidden_effect = {
		every_owned_state = {
			limit = {
				impassable = no
				has_dynamic_modifier = {
					modifier = MGY_MODIFIER_LocalUnrest_Dynmod
				}
			}
			owner = {
				add_to_variable = {
					MGY_TotalUnrest_var = PREV.MGY_StateUnrest_var
				}
			}
		}
	}
}

#Effect to get the mean total unrest in the country
MGY_Unrest_GetAverage_effect = {
	MGY_Unrest_GetNumberOfPossibleStates_effect = yes
	MGY_Unrest_GetTotalSum_effect = yes
	set_variable = {
		MGY_Unrest_Average_var = 0
	}
	add_to_variable = {
		MGY_Unrest_Average_var = MGY_TotalUnrest_var
	}
	divide_variable = {
		MGY_Unrest_Average_var = MGY_OwnedStates_var
	}
	set_variable = {
		MGY_Unrest_DoubleAverage_var = MGY_Unrest_Average_var
	}
	multiply_variable = {
		MGY_Unrest_DoubleAverage_var = 2
	}
	log = "[GetDateText] SOTN: Recalculating average unrest out of [?ROOT.MGY_OwnedStates_var] possible states: [?ROOT.MGY_Unrest_Average_var]"
}

#Effect to get the impact of the average unrest on the country, as variables
MGY_Unrest_GetImpact_effect = {
	set_variable = {
		MGY_UnrestImpact_var = MGY_Unrest_Average_var
	}
	divide_variable = {
		MGY_UnrestImpact_var = -100
	}
	set_variable = {
		MGY_UnrestImpactSmall_var = MGY_UnrestImpact_var
	}
	divide_variable = {
		MGY_UnrestImpactSmall_var = 2
	}
}

#Effect to handle state control change for unrest modifiers
MGY_Unrest_onStateOwnershipChange_effect = {
	if = {
		limit = {
			ROOT = {
				has_idea = MGY_PoliticalUnrest
			}
			FROM.FROM = {
				NOT = {
					has_dynamic_modifier = {
						modifier = MGY_MODIFIER_LocalUnrest_Dynmod
					}
				}
				NOT = {
					has_state_flag = MGY_Unrest_PacifiedState_flag
				}
				check_variable = {
					MGY_StateUnrest_var = 1
					compare = greater_than_or_equals
				}
				impassable = no
			}
		}
		FROM.FROM = {	
			log = "[GetDateText] SOTN: Re-enabling unrest modifier in [THIS.GetName], with an unrest value of [?THIS.MGY_StateUnrest_var]."
			add_dynamic_modifier = {
				modifier = MGY_MODIFIER_LocalUnrest_Dynmod
			}
		}
	}
	else_if = {
		limit = {
			NOT = {
				has_idea = MGY_PoliticalUnrest
			}
			FROM.FROM = {
				has_dynamic_modifier = {
					modifier = MGY_MODIFIER_LocalUnrest_Dynmod
				}
				impassable = no
			}
		}
		FROM.FROM = {
			log = "[GetDateText] SOTN: Removing unrest modifier from [THIS.GetName]"
			remove_dynamic_modifier = {
				modifier = MGY_MODIFIER_LocalUnrest_Dynmod
			}
		}
	}
}


# Effects to add unrest to a state (increments are 2, 5 and 10)
# Needs to be nested within a state for it to work

MGY_IncreaseStateUnrest_small_effect = { #Small unrest increase (2)
	log = "[GetDateText] SOTN: Increasing unrest in [THIS.GetName] by 10."
	custom_effect_tooltip = MGY_IncreaseStateUnrest_small_tt
	hidden_effect = {
		if = {
			limit = {
				NOT = {
					has_dynamic_modifier = {
						modifier = MGY_MODIFIER_LocalUnrest_Dynmod
					}
				}
			}
			add_dynamic_modifier = {
				modifier = MGY_MODIFIER_LocalUnrest_Dynmod
			}
		}
	}
	add_to_variable = {
		MGY_StateUnrest_var = 2
	}
	clamp_variable = {
		var = MGY_StateUnrest_var
		min = 1 #Unrest should always remain present
		max = 100 #Unrest should never get over 100
	}
	add_to_variable = { #Add to new variable, extract it, multiply it by -200 to get the proper value for the modifier
		MGY_StateUnrestImpact_var = MGY_StateUnrest_var
	}
	divide_variable = {
		MGY_StateUnrestImpact_var = -100
	}
	owner = { #Recalculate the Average unrest and dependent variable for the country itself
		MGY_Unrest_GetAverage_effect = yes
		MGY_Unrest_GetImpact_effect = yes
	}
}


MGY_IncreaseStateUnrest_medium_effect = { #Medium unrest increase (5)
	log = "[GetDateText] SOTN: Increasing unrest in [THIS.GetName] by 10."
	custom_effect_tooltip = MGY_IncreaseStateUnrest_medium_tt
	hidden_effect = {
		if = {
			limit = {
				NOT = {
					has_dynamic_modifier = {
						modifier = MGY_MODIFIER_LocalUnrest_Dynmod
					}
				}
			}
			add_dynamic_modifier = {
				modifier = MGY_MODIFIER_LocalUnrest_Dynmod
			}
		}
	}
	add_to_variable = {
		MGY_StateUnrest_var = 5
	}
	clamp_variable = {
		var = MGY_StateUnrest_var
		min = 1 #Unrest should always remain present
		max = 100 #Unrest should never get over 100
	}
	add_to_variable = { #Add to new variable, extract it, multiply it by -200 to get the proper value for the modifier
		MGY_StateUnrestImpact_var = MGY_StateUnrest_var
	}
	divide_variable = {
		MGY_StateUnrestImpact_var = -100
	}
	owner = { #Recalculate the Average unrest and dependent variable for the country itself
		MGY_Unrest_GetAverage_effect = yes
		MGY_Unrest_GetImpact_effect = yes
	}
}

MGY_IncreaseStateUnrest_large_effect = { #Large unrest increase (10)
	log = "[GetDateText] SOTN: Increasing unrest in [THIS.GetName] by 10."
	custom_effect_tooltip = MGY_IncreaseStateUnrest_large_tt
	hidden_effect = {
		if = {
			limit = {
				NOT = {
					has_dynamic_modifier = {
						modifier = MGY_MODIFIER_LocalUnrest_Dynmod
					}
				}
			}
			add_dynamic_modifier = {
				modifier = MGY_MODIFIER_LocalUnrest_Dynmod
			}
		}
	}
	add_to_variable = {
		MGY_StateUnrest_var = 10
	}
	clamp_variable = {
		var = MGY_StateUnrest_var
		min = 1 #Unrest should always remain present
		max = 100 #Unrest should never get over 100
	}
	add_to_variable = { #Add to new variable, extract it, multiply it by -200 to get the proper value for the modifier
		MGY_StateUnrestImpact_var = MGY_StateUnrest_var
	}
	divide_variable = {
		MGY_StateUnrestImpact_var = -100
	}
	owner = { #Recalculate the Average unrest and dependent variable for the country itself
		MGY_Unrest_GetAverage_effect = yes
		MGY_Unrest_GetImpact_effect = yes
	}
}

# Effects to lower unrest to a state (increments are -2, -5 and -10)
# Needs to be nested within a state for it to work

MGY_DecreaseStateUnrest_small_effect = { #Small unrest decrease (-2)
	log = "[GetDateText] SOTN: Decreasing unrest in [THIS.GetName] by -2."
	custom_effect_tooltip = MGY_DecreaseStateUnrest_small_tt
	hidden_effect = {
		if = {
			limit = {
				NOT = {
					has_dynamic_modifier = {
						modifier = MGY_MODIFIER_LocalUnrest_Dynmod
					}
				}
			}
			add_dynamic_modifier = {
				modifier = MGY_MODIFIER_LocalUnrest_Dynmod
			}
		}
	}
	add_to_variable = {
		MGY_StateUnrest_var = -2
	}
	clamp_variable = {
		var = MGY_StateUnrest_var
		min = 1 #Unrest should always remain present
		max = 100 #Unrest should never get over 100
	}
	add_to_variable = { #Add to new variable, extract it, multiply it by -200 to get the proper value for the modifier
		MGY_StateUnrestImpact_var = MGY_StateUnrest_var
	}
	divide_variable = {
		MGY_StateUnrestImpact_var = -100
	}
	owner = { #Recalculate the Average unrest and dependent variable for the country itself
		MGY_Unrest_GetAverage_effect = yes
		MGY_Unrest_GetImpact_effect = yes
	}
}


MGY_DecreaseStateUnrest_medium_effect = { #Medium unrest decrease (-5)
	log = "[GetDateText] SOTN: Decreasing unrest in [THIS.GetName] by -5."
	custom_effect_tooltip = MGY_DecreaseStateUnrest_medium_tt
	hidden_effect = {
		if = {
			limit = {
				NOT = {
					has_dynamic_modifier = {
						modifier = MGY_MODIFIER_LocalUnrest_Dynmod
					}
				}
			}
			add_dynamic_modifier = {
				modifier = MGY_MODIFIER_LocalUnrest_Dynmod
			}
		}
	}
	add_to_variable = {
		MGY_StateUnrest_var = -5
	}
	clamp_variable = {
		var = MGY_StateUnrest_var
		min = 1 #Unrest should always remain present
		max = 100 #Unrest should never get over 100
	}
	add_to_variable = { #Add to new variable, extract it, multiply it by -200 to get the proper value for the modifier
		MGY_StateUnrestImpact_var = MGY_StateUnrest_var
	}
	divide_variable = {
		MGY_StateUnrestImpact_var = -100
	}
	owner = { #Recalculate the Average unrest and dependent variable for the country itself
		MGY_Unrest_GetAverage_effect = yes
		MGY_Unrest_GetImpact_effect = yes
	}
}

MGY_DecreaseStateUnrest_large_effect = { #Large unrest decrease (-10)
	log = "[GetDateText] SOTN: Decreasing unrest in [THIS.GetName] by -10."
	custom_effect_tooltip = MGY_DecreaseStateUnrest_large_tt
	hidden_effect = {
		if = {
			limit = {
				NOT = {
					has_dynamic_modifier = {
						modifier = MGY_MODIFIER_LocalUnrest_Dynmod
					}
				}
			}
			add_dynamic_modifier = {
				modifier = MGY_MODIFIER_LocalUnrest_Dynmod
			}
		}
	}
	add_to_variable = {
		MGY_StateUnrest_var = -10
	}
	clamp_variable = {
		var = MGY_StateUnrest_var
		min = 1 #Unrest should always remain present
		max = 100 #Unrest should never get over 100
	}
	add_to_variable = { #Add to new variable, extract it, multiply it by -200 to get the proper value for the modifier
		MGY_StateUnrestImpact_var = MGY_StateUnrest_var
	}
	divide_variable = {
		MGY_StateUnrestImpact_var = -100
	}
	owner = { #Recalculate the Average unrest and dependent variable for the country itself
		MGY_Unrest_GetAverage_effect = yes
		MGY_Unrest_GetImpact_effect = yes
	}
}

#Master effect to enable and setup the urnest mechanics - not all states start with unrest
MGY_UnrestStartup_effect = {
	740 = {
		log = "[GetDateText] SOTN: Enabling unrest in setup for the state of [THIS.GetName]."
		add_dynamic_modifier = {
			modifier = MGY_MODIFIER_LocalUnrest_Dynmod
		}
		set_variable = {
			MGY_StateUnrest_var = 20
		}
		set_variable = {
			MGY_StateUnrestImpact_var = -0.2
		}
	}
	738 = {
		log = "[GetDateText] SOTN: Enabling unrest in setup for the state of [THIS.GetName]."
		add_dynamic_modifier = {
			modifier = MGY_MODIFIER_LocalUnrest_Dynmod
		}
		set_variable = {
			MGY_StateUnrest_var = 20
		}
		set_variable = {
			MGY_StateUnrestImpact_var = -0.2
		}
	}
	735 = {
		log = "[GetDateText] SOTN: Enabling unrest in setup for the state of [THIS.GetName]."
		add_dynamic_modifier = {
			modifier = MGY_MODIFIER_LocalUnrest_Dynmod
		}
		set_variable = {
			MGY_StateUnrest_var = 15
		}
		set_variable = {
			MGY_StateUnrestImpact_var = -0.15
		}
	}
	758 = {
		log = "[GetDateText] SOTN: Enabling unrest in setup for the state of [THIS.GetName]."
		add_dynamic_modifier = {
			modifier = MGY_MODIFIER_LocalUnrest_Dynmod
		}
		set_variable = {
			MGY_StateUnrest_var = 10
		}
		set_variable = {
			MGY_StateUnrestImpact_var = -0.1
		}
	}
	759 = {
		log = "[GetDateText] SOTN: Enabling unrest in setup for the state of [THIS.GetName]."
		add_dynamic_modifier = {
			modifier = MGY_MODIFIER_LocalUnrest_Dynmod
		}
		set_variable = {
			MGY_StateUnrest_var = 10
		}
		set_variable = {
			MGY_StateUnrestImpact_var = -0.1
		}
	}
	760 = {
		log = "[GetDateText] SOTN: Enabling unrest in setup for the state of [THIS.GetName]."
		add_dynamic_modifier = {
			modifier = MGY_MODIFIER_LocalUnrest_Dynmod
		}
		set_variable = {
			MGY_StateUnrest_var = 15
		}
		set_variable = {
			MGY_StateUnrestImpact_var = -0.15
		}
	}
	761 = {
		log = "[GetDateText] SOTN: Enabling unrest in setup for the state of [THIS.GetName]."
		add_dynamic_modifier = {
			modifier = MGY_MODIFIER_LocalUnrest_Dynmod
		}
		set_variable = {
			MGY_StateUnrest_var = 15
		}
		set_variable = {
			MGY_StateUnrestImpact_var = -0.15
		}
	}
	763 = {
		log = "[GetDateText] SOTN: Enabling unrest in setup for the state of [THIS.GetName]."
		add_dynamic_modifier = {
			modifier = MGY_MODIFIER_LocalUnrest_Dynmod
		}
		set_variable = {
			MGY_StateUnrest_var = 10
		}
		set_variable = {
			MGY_StateUnrestImpact_var = -0.1
		}
	}
	766 = {
		log = "[GetDateText] SOTN: Enabling unrest in setup for the state of [THIS.GetName]."
		add_dynamic_modifier = {
			modifier = MGY_MODIFIER_LocalUnrest_Dynmod
		}
		set_variable = {
			MGY_StateUnrest_var = 10
		}
		set_variable = {
			MGY_StateUnrestImpact_var = -0.1
		}
	}
	770 = {
		log = "[GetDateText] SOTN: Enabling unrest in setup for the state of [THIS.GetName]."
		add_dynamic_modifier = {
			modifier = MGY_MODIFIER_LocalUnrest_Dynmod
		}
		set_variable = {
			MGY_StateUnrest_var = 15
		}
		set_variable = {
			MGY_StateUnrestImpact_var = -0.15
		}
	}
	MGY_Unrest_GetAverage_effect = yes
	MGY_Unrest_GetImpact_effect = yes
	add_dynamic_modifier = {
		modifier = MGY_PoliticalUnrest_Dynmod
	}
}

###########################
# Legacy of the Storm Change
###########################

MGY_Misc_DealWithStorm_effect = {
	if = {
		limit = {
			OR = {
				has_dynamic_modifier = {
					modifier = MGY_MODIFIER_StormKing_Dynmod
				}
				has_idea = zebrica_legacy_of_storm1
			}
			check_variable = {
				MGY_StormKing_ConsumerGoods_var > 0.006
			}
		}
		custom_effect_tooltip = MGY_StormEffectsWillLower_tt
		add_to_variable = {
			MGY_StormKing_ConsumerGoods_var = -0.003
		}
		clamp_variable = {
			var = MGY_StormKing_ConsumerGoods_var
			min = 0
		}
		add_to_variable = {
			MGY_StormKing_PolPower_var = -0.002
		}
		clamp_variable = {
			var = MGY_StormKing_PolPower_var
			min = 0
		}
		add_to_variable = {
			MGY_StormKing_StabFactor_var = -0.002
		}
		clamp_variable = {
			var = MGY_StormKing_StabFactor_var
			min = 0
		}
		add_to_variable = {
			MGY_StormKing_ArmmMorale_var = -0.003
		}
		clamp_variable = {
			var = MGY_StormKing_ArmmMorale_var
			min = 0
		}
		add_to_variable = {
			MGY_StormKing_ArmOrg_var = -0.001
		}
		clamp_variable = {
			var = MGY_StormKing_ArmOrg_var
			min = 0
		}
		add_to_variable = {
			MGY_StormKing_ConscriptionFactor_var = -0.001
		}
		clamp_variable = {
			var = MGY_StormKing_ConscriptionFactor_var
			min = 0
		}
	}
	else_if = {
		limit = {
			OR = {
				has_dynamic_modifier = {
					modifier = MGY_MODIFIER_StormKing_Dynmod
				}
				has_idea = zebrica_legacy_of_storm1
			}
			OR = {
				check_variable = {
					MGY_StormKing_ConsumerGoods_var = 0.006
				}
				check_variable = {
					MGY_StormKing_ConsumerGoods_var < 0.006
				}
			}
		}
		custom_effect_tooltip = MGY_StormEffectsWillEnd_tt
		custom_effect_tooltip = MGY_DoubleSpace_tt
		remove_dynamic_modifier = {
			modifier = MGY_MODIFIER_StormKing_Dynmod
		}
		hidden_effect = {
			country_event = MGY_FocusEconomy.2
		}
	}
	else = {
		custom_effect_tooltip = MGY_StormEffectsRecovery_tt
		add_political_power = 50
	}
}

###########################
# Granry of Zebrica Effects
###########################

MGY_Granary_Setup_effect = {
	set_variable = {
		MGY_Grain_var = 50
	}
	set_variable = {
		MGY_Grain_increase_var = 5
	}
	set_variable = {
		MGY_Grain_increase_factor_var = 0
	}
	set_variable = {
		MGY_Grain_max_var = 100
	}
	set_variable = {
		MGY_Grain_max_factor_var = 0
	}
	set_variable = {
		MGY_GranaryPolCost_var = 20
	}
	set_variable = {
		MGY_GranaryPonypowerSmallCost_var = 1000
	}
	set_variable = {
		MGY_GranaryPonypowerLargeCost_var = 2500
	}
	add_dynamic_modifier = {
		modifier = MGY_GranaryFoodImport_Dynmod
	}
}

MGY_Granary_CalcPercentageGain_effect = { #Updates the real food gain: MGY_Grain_increase_var x ( MGY_Grain_increase_factor_var + 1) = MGY_WeeklyFoodChange_var
	# Fetch the Variables
	set_temp_variable = {
		# base food gain
		MGY_Grain_increase_tempvar = MGY_Grain_increase_var
	}
	set_temp_variable = {
		# percentage
		MGY_Grain_increase_factor_tempvar = MGY_Grain_increase_factor_var
	}
	add_to_temp_variable = {
		#Adjust for multiplier
		MGY_Grain_increase_factor_tempvar = 1
	}
	multiply_temp_variable = {
		# Multiply
		var = MGY_Grain_increase_tempvar
		value = MGY_Grain_increase_factor_tempvar
	}
	set_variable = {
		#Store result in non-temporary variable: THIS is the display variable
		MGY_WeeklyFoodChange_var = MGY_Grain_increase_tempvar
	}
}

MGY_Granary_CalcPercentageMax_effect = { #Updates the real maximum food: MGY_Grain_max_var x ( MGY_Grain_max_factor_var + 1)
	# Fetch the Variables
	set_temp_variable = {
		# base food gain
		MGY_Grain_max_tempvar = MGY_Grain_max_var
	}
	set_temp_variable = {
		# percentage
		MGY_Grain_max_factor_tempvar = MGY_Grain_max_factor_var
	}
	add_to_temp_variable = {
		#Adjust for multiplier
		MGY_Grain_max_factor_tempvar = 1
	}
	multiply_temp_variable = {
		# Multiply
		var = MGY_Grain_max_tempvar
		value = MGY_Grain_max_factor_tempvar
	}
	set_variable = {
		#Store result in non-temporary variable: THIS is the display variable
		MGY_Grain_capacity_var = MGY_Grain_max_tempvar
	}
}

MGY_Granary_CheckFoodNeeds_effects = { #Effect only triggers if food is in the negative. The higher the negative, the higher the consumer goods factor penalty
	if = {
		limit = {
			check_variable = {
				var = MGY_Grain_var
				value = 0
				compare = less_than
			}
		}
		set_temp_variable = {
			MGY_FoodNeedImpact_tempvar = MGY_Grain_var
		}
		multiply_temp_variable = {
			MGY_FoodNeedImpact_tempvar = -0.005
		}
		# Adjustment section. The effects from the penalty should scale with the maximum grain penalty.
		set_temp_variable = {
			MGY_Grain_max_tempvar = MGY_Grain_capacity_var
		}
		divide_temp_variable = {
			var = MGY_FoodNeedImpact_tempvar
			valu = MGY_Grain_max_tempvar
		}
		clamp_variable = {
			var = MGY_FoodNeedImpact_tempvar
			min = 0
			max = 100
		}
		set_variable = {
			MGY_FoodNeedImpact_var = MGY_FoodNeedImpact_tempvar
		}
	}
	else = {
		set_variable = {
			MGY_FoodNeedImpact_var = 0
		}
	}
}

MGY_Granary_OnWeek_effect = { #As on the tin, updates the food gain per week
	# Update the variables
	MGY_Granary_CalcPercentageGain_effect = yes
	MGY_Granary_CalcPercentageMax_effect = yes
	# Add to Variable
	add_to_variable = {
		MGY_Grain_var = MGY_WeeklyFoodChange_var
	}
	# Clamp the Variable to its maximum
	clamp_variable = {
		var = MGY_Grain_var
		max = MGY_Grain_capacity_var
	}
	# Check the food need effects
	MGY_Granary_CheckFoodNeeds_effects = yes
}