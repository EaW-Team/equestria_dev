#==============================#
### Karamelka's advisors GUI ###
#==============================#
# Made by Scars

### Initialization of the GUI itself, compute x and y values, etc.
STG_advisors_init = {
	set_country_flag = KRMLK_active
	## The x and y coordinates of where the advisors are as they rely on a gridbox to render
	clear_array = KRMLK_advisors_x
	clear_array = KRMLK_advisors_y
	add_to_array = { KRMLK_advisors_x = 21 }
	add_to_array = { KRMLK_advisors_y = 206 }
	add_to_array = { KRMLK_advisors_x = 72 }
	add_to_array = { KRMLK_advisors_y = 85 }
	add_to_array = { KRMLK_advisors_x = 193 }
	add_to_array = { KRMLK_advisors_y = 34 }
	add_to_array = { KRMLK_advisors_x = 314 }
	add_to_array = { KRMLK_advisors_y = 85 }
	add_to_array = { KRMLK_advisors_x = 366 }
	add_to_array = { KRMLK_advisors_y = 206 }

	## Advisors are tokens of hidden ideas defined in zzz_STG_karamelkas_advisors_ideas.txt
	clear_array = KRMLK_active_advisors
	resize_array = { array = KRMLK_active_advisors value = token:STG_KRMLK_no_advisor size = 5 }

	# Cooldowns of each slot, done like this so there can be tooltips and OOPs
	clear_array = KRMLK_advisor_slot_cooldown
	resize_array = { array = KRMLK_advisor_slot_cooldown value = 0 size = 5 }

	# Cooldown logic
	clear_array = KRMLK_cooldown_timer
	clear_array = KRMLK_cooldown_array
	resize_array = { array = KRMLK_cooldown_timer value = -1 size = 20 }
	resize_array = { array = KRMLK_cooldown_array value = -1 size = 20 }
	
	clear_array = KRMLK_available_advisors
	add_to_array = { KRMLK_available_advisors = token:STG_KRMLK_test_1 }
	add_to_array = { KRMLK_available_advisors = token:STG_KRMLK_test_2 }
	add_to_array = { KRMLK_available_advisors = token:STG_KRMLK_test_3 }
	add_to_array = { KRMLK_available_advisors = token:STG_KRMLK_test_reset_guy }
	
	clear_array = KRMLK_advisors_cooldown_tracker
	clear_array = KRMLK_advisors_cooldown_tracker_ref
	resize_array = { array = KRMLK_advisors_cooldown_tracker value = -1 size = 4 }
	resize_array = { array = KRMLK_advisors_cooldown_tracker_ref value = -1 size = 4 }

	## Tick of the advisors
	clear_array = KRMLK_ticks
	resize_array = { array = KRMLK_ticks value = -1 size = 5 }

	add_to_variable = { KRMLK_dirty = 0.01 }
}

# Effect to set the tick delay of an idea
# Arguments: temp_tick_days, temp_id
KRMLK_set_tick = {
	set_temp_variable = { temp_value = temp_id }
	KRMLK_find_index = yes

	set_variable = { KRMLK_ticks^out_index = temp_tick_days }
}

# Shorthand function to get the index of the value in KRMLK_active_advisors or KRMLK_available_advisors
# Arguments: temp_value
# Output: out_index

KRMLK_find_index = {
	for_each_loop = {
		array = KRMLK_active_advisors
		value = find_v
		index = find_i
		break = b
		if = {
			limit = {
				check_variable = { find_v = temp_value }
			}
			set_temp_variable = { out_index = find_i }
			set_temp_variable = { b = 1 }
		}
	}
}

KRMLK_find_index_in_available = {
	for_each_loop = {
		array = KRMLK_available_advisors
		value = find_v
		index = find_i
		break = b
		if = {
			limit = {
				check_variable = { find_v = temp_value }
			}
			set_temp_variable = { out_index = find_i }
			set_temp_variable = { b = 1 }
		}
	}
}

#################
### Front End ###
#################

## Adds an advisor to the pool of selectable advisors
# Arguments: temp_advisor
STG_KRMLK_add_to_available_advisors = {
	add_to_array = { KRMLK_available_advisors = temp_advisor }
	add_to_array = { KRMLK_advisors_cooldown_tracker = -1 }
	add_to_array = { KRMLK_advisors_cooldown_tracker_ref = -1 }
	custom_effect_tooltip = STG_KRMLK_add_to_available_advisors_tt
	
	set_temp_variable = { added_index = KRMLK_available_advisors^num }
	subtract_from_temp_variable = { added_index = 1 }
	add_to_variable = { KRMLK_dirty = 0.01 }
}

## Removes an advisor from the pool of selectable advisors and the active advisor board if active
# Arguments: temp_advisor
STG_KRMLK_remove_from_available_advisors = {
	custom_effect_tooltip = STG_KRMLK_remove_from_available_advisors_tt
	hidden_effect = {
		if = {
			limit = {
				is_in_array = { KRMLK_available_advisors = temp_advisor }
			}
			set_temp_variable = { temp_value = temp_advisor }
			KRMLK_find_index_in_available = yes
			remove_from_array = { array = KRMLK_advisors_cooldown_tracker index = out_index }
			remove_from_array = { array = KRMLK_advisors_cooldown_tracker_ref index = out_index }
			remove_from_array = { KRMLK_available_advisors = temp_advisor }
		}
		else_if = {
			limit = {
				is_in_array = { KRMLK_active_advisors = temp_advisor }
			}
			set_temp_variable = { temp_value = temp_advisor }
			KRMLK_find_index = yes

			set_variable = { KRMLK_active_advisors^out_index = token:STG_KRMLK_no_advisor }
			set_variable = { KRMLK_ticks^out_index = -1 }
			meta_effect = {
				text = {
					remove_ideas = [INPUT]
				}
				INPUT = "[?temp_advisor.GetTokenKey]"
			}
		}
	}
	add_to_variable = { KRMLK_dirty = 0.01 }
}

## Removes this advisor and puts them on cooldown
# Arguments: temp_advisor, temp_cooldown
STG_KRMLK_set_cooldown = {
	custom_effect_tooltip = STG_KRLMK_set_cooldown_tt
	log = "STG_KRMLK_set_cooldown activated"
	log = "temp_advisor: [?temp_advisor.GetTokenKey]"
	log = "temp_cooldown: [?temp_cooldown]"
	hidden_effect = {
		set_temp_variable = { temp_value = temp_advisor }
		KRMLK_find_index = yes
		set_variable = { KRMLK_active_advisors^out_index = token:STG_KRMLK_no_advisor }
		set_variable = { KRMLK_advisor_slot_cooldown^out_index = 0 }
		meta_effect = {
			text = {
				remove_ideas = [INPUT]
			}
			INPUT = "[?temp_advisor.GetTokenKey]"
		}

		for_each_loop = {
			array = KRMLK_cooldown_timer
			break = b
			if = {
				limit = {
					check_variable = { v = -1 }
				}
				set_temp_variable = { valid_index = i }
				set_temp_variable = { b = 1 }
			}
		}
		set_variable = { KRMLK_cooldown_timer^valid_index = temp_cooldown }
		set_variable = { KRMLK_cooldown_array^valid_index = temp_advisor }

		STG_KRMLK_add_to_available_advisors = yes
		set_temp_variable = { temp_value = temp_advisor }
		KRMLK_find_index_in_available = yes
		set_variable = { KRMLK_advisors_cooldown_tracker^added_index = temp_cooldown }
		set_variable = { KRMLK_advisors_cooldown_tracker_ref^added_index = valid_index }
	}
	add_to_variable = { KRMLK_dirty = 0.01 }
}

### Effects for advisor ticks ###
# Format: <advisor token ID>_effect
# gets triggered from eaw_on_daily_on_actions.txt when respective tick reaches -1
# search keyword "Karamelka"

STG_KRMLK_test_1_tick_effect = {
	random_owned_controlled_state = {
		add_extra_state_shared_building_slots = 1
		add_building_construction = {
			type = arms_factory
			level = 1
			instant_build = yes
		}
	}
	set_temp_variable = { temp_advisor = token:STG_KRMLK_test_1 }
	set_temp_variable = { temp_cooldown = KRMLK_advisor_slot_cooldown^advisor_i }
	STG_KRMLK_set_cooldown = yes
}

STG_KRMLK_test_2_tick_effect = {
	set_temp_variable = { temp_advisor = token:STG_KRMLK_test_2 }
	set_temp_variable = { temp_cooldown = KRMLK_advisor_slot_cooldown^advisor_i }
	STG_KRMLK_set_cooldown = yes
}

STG_KRMLK_test_3_tick_effect = {
	custom_effect_tooltip = STG_KRMLK_test_3_tick_tt
	subtract_from_variable = { KRMLK_test_3_stability_factor = 0.05 }

	set_temp_variable = { temp_tick_days = 15 }
	set_temp_variable = { temp_id = token:STG_KRMLK_test_3 }
	KRMLK_set_tick = yes
}

STG_KRMLK_test_reset_guy_tick_effect = {
	custom_effect_tooltip = STG_KRMLK_test_reset_guy_tick_tt
	
	# Resets all cooldowns
	for_each_loop = {
		array = KRMLK_cooldown_array
		if = {
			limit = {
				NOT = {
					check_variable = { v = -1 }
				}
			}
			set_variable = { KRMLK_cooldown_array^i = -1 }
			set_variable = { KRMLK_cooldown_timer^i = -1 }
		}
	}
	for_loop_effect = {
		start = 0
		end = KRMLK_advisors_cooldown_tracker^num
		value = i
		set_variable = { KRMLK_advisors_cooldown_tracker^i = -1 }
		set_variable = { KRMLK_advisors_cooldown_tracker_ref^i = -1 }
	}

	set_temp_variable = { temp_advisor = token:STG_KRMLK_test_reset_guy }
	set_temp_variable = { temp_cooldown = KRMLK_advisor_slot_cooldown^advisor_i }
	STG_KRMLK_set_cooldown = yes
}

# Ignore
STG_KRMLK_no_advisor_tick_effect = {
}