# This file contain the effect to interact with the diary GUI

@DIARY_NB_CATEGORIES = 4
@MAX_QUEST_ENTRY_NB = 256

# Function    : f_VED_refresh_diary_gui
# Description : Refresh the diary GUI
# Inputs      : None
# Outputs     : None
f_VED_refresh_diary_gui = {
	add_to_variable = { VED_quest_diary_gui_update = 1 }
}

# Function    : f_VED_open_diary
# Description : Open the diary GUI 
# Inputs      : i_diary_category - Indicate which content will be displayed when the diary is opened
# Outputs     : None
f_VED_open_diary = {
	# Display the diary using the flag
	set_country_flag = VED_display_quest_diary
	# Sanity checks on inputs
	if = {
		limit = { check_variable = { i_diary_category < 0 } }
		set_temp_variable = { i_diary_category = 0 }
	}
	if = {
		limit = {
			check_variable = {
				var = i_diary_category
				value = @DIARY_NB_CATEGORIES
				compare = greater_than_or_equals
			}
		}
		set_temp_variable = { i_diary_category = @DIARY_NB_CATEGORIES }
		add_to_temp_variable = { i_diary_category = -1 }
	}

	clear_array = VED_quest_diary_content_array
	add_to_array = { VED_quest_diary_content_array = i_diary_category }

	# Populate the bookmark arrays
	resize_array = {
		array = VED_quest_diary_left_bookmark_array
		size = 4
	}
	resize_array = {
		array = VED_quest_diary_right_bookmark_array
		size = 4
	}

	# Update the diary GUI
	f_VED_refresh_diary_gui = yes
}

# Adventure log functions

@QUEST_ENTRY_BASE_HEIGHT = 30
@QUEST_ENTRY_LINE_HEIGHT = 12
@ADVENTURE_LOG_PAGE_HEIGHT = 500

# Function    : f_VED_log_value_to_quest_entry_id
# Description : Convert a log value to the corresponding quest and entry id
# 				Used to store in the same variable all the information of the entry
# Inputs      : i_log_id   - The log calue to convert
# Outputs     : o_quest_id - The quest id
#             : o_entry_id - The entry id
f_VED_log_value_to_quest_entry_id = {
	set_temp_variable = { o_entry_id = i_log_id }
	modulo_temp_variable = { o_entry_id = @MAX_QUEST_ENTRY_NB }
	set_temp_variable = { o_quest_id = i_log_id }
	subtract_from_temp_variable = { o_quest_id = o_entry_id }
	divide_temp_variable = { o_quest_id = @MAX_QUEST_ENTRY_NB }
}

# Function    : f_VED_quest_entry_id_to_log_value
# Description : Convert a quest and entry id to a unique log value
# 				Used to store in the same variable all the information of the entry
# Inputs      : i_quest_id - The quest id to convert
#             : i_entry_id - The entry id to convert
# Outputs     : o_log_id   - The resulting log value

f_VED_quest_entry_id_to_log_value = {
	set_temp_variable = { o_entry_id = i_log_id }
	modulo_temp_variable = { o_entry_id = @MAX_QUEST_ENTRY_NB }
	set_temp_variable = { o_quest_id = i_log_id }
	subtract_from_temp_variable = { o_quest_id = o_entry_id }
	divide_temp_variable = { o_quest_id = @MAX_QUEST_ENTRY_NB }
}

# Function    : f_VED_log_entries_database_setup
# Description : Setup the number of quests and their number of entries
# Inputs      : i_diary_category - Indicate which content will be displayed when the diary is opened
# Outputs     : VED_diary_quest_log_entries_array - Array containing the number of entries per quest.
#				The number of elements itself is the number of quests
f_VED_log_entries_database_setup = {
	# Debug : Dummy quest entries for now
	clear_array = VED_diary_quest_log_entries_array
	add_to_array = { VED_diary_quest_log_entries_array = 3 }
	add_to_array = { VED_diary_quest_log_entries_array = 1 }
	add_to_array = { VED_diary_quest_log_entries_array = 5 }
}

# Function    : f_VED_refresh_adventure_log_display
# Description : Refresh the display of the adventure log
# Inputs      : i_page_nb : The left page number
# Outputs     : None
f_VED_refresh_adventure_log_display = {
	# Reset the display arrays
	# Left page
	clear_array = VED_quest_diary_tab_3_left_log_array
	clear_array = VED_quest_diary_tab_3_left_log_date_array
	clear_array = VED_quest_diary_tab_3_left_log_location_array
	clear_array = VED_quest_diary_tab_3_left_log_offsets_array
	# Right page
	clear_array = VED_quest_diary_tab_3_right_log_array
	clear_array = VED_quest_diary_tab_3_right_log_date_array
	clear_array = VED_quest_diary_tab_3_right_log_location_array
	clear_array = VED_quest_diary_tab_3_right_log_offsets_array

	# Sanity checks
	round_temp_variable = i_page_nb
	set_temp_variable = { t_max_page_nb = VED_quest_diary_adventure_log_page_index^num }
	add_to_temp_variable = { t_max_page_nb = -1 }
	if = {
		limit = { check_variable = { t_max_page_nb > -1 } }

		clamp_temp_variable = {
			var = i_page_nb
			min = 0
			max = t_max_page_nb
		}

		f_VED_refresh_adventure_log_display_private = yes
	}
}

# Function    : f_VED_refresh_adventure_log_display_private
f_VED_refresh_adventure_log_display_private = {
	# Fill left page
	set_temp_variable = { t_start_index = VED_quest_diary_adventure_log_page_index^i_page_nb }
	add_to_temp_variable = { i_page_nb = 1 }
	if = {
		limit = { check_variable = { i_page_nb > t_max_page_nb } }
		
		set_temp_variable = { t_stop_index = VED_quest_diary_adventure_log_entries_content^num }
	} else = {
		set_temp_variable = { t_stop_index = VED_quest_diary_adventure_log_page_index^i_page_nb }
	}
	set_temp_variable = { t_index = 0 }
	while_loop_effect = {
		limit = { check_variable = { t_start_index < t_stop_index } }
		
		# Update the left array
		add_to_array = { VED_quest_diary_tab_3_left_log_array          = VED_quest_diary_adventure_log_entries_content^t_start_index }
		add_to_array = { VED_quest_diary_tab_3_left_log_date_array     = VED_quest_diary_adventure_log_entries_date^t_start_index }
		add_to_array = { VED_quest_diary_tab_3_left_log_location_array = VED_quest_diary_adventure_log_entries_location^t_start_index }
		add_to_array = { VED_quest_diary_tab_3_left_log_offsets_array  = VED_quest_diary_adventure_log_offset^t_start_index }

		add_to_temp_variable = { t_start_index = 1 }
	}


	# Fill right page
	add_to_temp_variable = { i_page_nb = 1 }
	set_temp_variable = { t_start_index = t_stop_index }
	add_to_temp_variable = { t_start_index = 1 }
	if = {
		limit = { check_variable = { i_page_nb < VED_quest_diary_adventure_log_page_index^num } }

		# As for the left page, fill the right page
		if = {
			limit = { check_variable = { i_page_nb > t_max_page_nb } }
			
			set_temp_variable = { t_stop_index = VED_quest_diary_adventure_log_entries_content^num }
		} else = {
			set_temp_variable = { t_stop_index = VED_quest_diary_adventure_log_page_index^i_page_nb }
		}
		set_temp_variable = { t_index = 0 }
		while_loop_effect = {
			limit = { check_variable = { t_start_index < t_stop_index } }
			
			# Update the left array
			add_to_array = { VED_quest_diary_tab_3_right_log_array          = VED_quest_diary_adventure_log_entries_content^t_start_index }
			add_to_array = { VED_quest_diary_tab_3_right_log_date_array     = VED_quest_diary_adventure_log_entries_date^t_start_index }
			add_to_array = { VED_quest_diary_tab_3_right_log_location_array = VED_quest_diary_adventure_log_entries_location^t_start_index }
			add_to_array = { VED_quest_diary_tab_3_right_log_offsets_array  = VED_quest_diary_adventure_log_offset^t_start_index }
	
			add_to_temp_variable = { t_start_index = 1 }
		}
	}
}

# Function    : f_VED_add_entry_adventure_log
# Description : Add an entry to the adventure log
# Inputs      : i_quest_id - The input quest ID to add
#             : i_entry_id - The quest entry ID to add
#             : i_location - A token for the localization of the location of the entry
#             : i_date     - The date of the entry
# Outputs     : None
f_VED_add_entry_adventure_log = {
	# Sanity checks on input ids
	set_temp_variable = { t_max_quest_id = VED_diary_quest_log_entries_array^num }
	add_to_temp_variable = { t_max_quest_id = -1 }
	round_temp_variable = i_quest_id
	clamp_temp_variable = {
		var = i_quest_id
		min = 0
		max = t_max_quest_id
	}
	set_temp_variable = { t_max_entry_id = VED_diary_quest_log_entries_array^i_quest_id }
	add_to_temp_variable = { t_max_entry_id = -1 }
	round_temp_variable = i_entry_id
	clamp_temp_variable = {
		var = i_entry_id
		min = 0
		max = t_max_entry_id
	}

	# Quest the value to add
	f_VED_quest_entry_id_to_log_value = yes # o_log_id

	# Add the data to the arrays
	set_temp_variable = { t_index_val = VED_quest_diary_adventure_log_offset^num }
	meta_effect = {
		text = {
			add_to_array = {
				VED_quest_diary_adventure_log_entries_content = token:VED_diary_log_entry_[QUEST_ID]_[ENTRY_ID]_text
			}
			set_temp_variable = { t_line_nb = token:VED_diary_log_entry_[QUEST_ID]_[ENTRY_ID]_line_nb }
		}

		QUEST_ID = "[?i_quest_id]"
		ENTRY_ID = "[?i_entry_id]"
	}
	add_to_array = { VED_quest_diary_adventure_log_entries_date = i_date }
	add_to_array = { VED_quest_diary_adventure_log_entries_location = i_location }
	add_to_array = { VED_quest_diary_adventure_log_offset = VED_quest_diary_adventure_log_current_offset }

	# Compute the nex offset of the entries
	add_to_variable = { VED_quest_diary_adventure_log_current_offset = @QUEST_ENTRY_BASE_HEIGHT }
	multiply_temp_variable = { t_line_nb = @QUEST_ENTRY_LINE_HEIGHT }
	add_to_variable = { VED_quest_diary_adventure_log_current_offset = t_line_nb }
	if = {
		limit = { check_variable = { VED_quest_diary_adventure_log_current_offset > @ADVENTURE_LOG_PAGE_HEIGHT } }

		set_variable = { VED_quest_diary_adventure_log_current_offset = 0 }
		add_to_array = { VED_quest_diary_adventure_log_page_index = t_index_val }
	}
}

# Function    : f_VED_reset_adventure_log
# Description : Reset the adventure log
# Inputs      : None
# Outputs     : None
f_VED_reset_adventure_log = {
	# Entries information arrays
	# Entry token array - Contain entry tokens
	clear_array = VED_quest_diary_adventure_log_entries_content
	# Date array - Contain the date of the entry
	clear_array = VED_quest_diary_adventure_log_entries_date
	# Location array - Contain the location of the entry
	clear_array = VED_quest_diary_adventure_log_entries_location

	# Metadata used for the display
	# Entries offset array
	clear_array = VED_quest_diary_adventure_log_offset
	set_variable = { VED_quest_diary_adventure_log_current_offset = 0 }
	# Page index array
	clear_array = VED_quest_diary_adventure_log_page_index
	add_to_array = { VED_quest_diary_adventure_log_page_index = 0 }
}