show_faction_invited_popup = {
	if = {
		limit = {
			OR = {
				is_nearby_for_popup = yes
				is_major_for_popup = yes
			}
		}
		eaw_diplo_popup_generate_unique_id = yes
		eaw_diplo_popup_initiate_cooldown = yes
		add_to_array = { eaw_diplo_popup_unique_id = temp_unique_popup_id }
		add_to_array = { eaw_diplo_popup_sender = FROM }
		add_to_array = { eaw_diplo_popup_reciever = FROM.FROM }
		add_to_array = { eaw_diplo_popup_type = 1 }
		add_to_array = { eaw_diplo_popup_initial_date = global.date }
		scoped_sound_effect = diplomatic_notification
	}
}

show_faction_joined_popup = {
	if = {
		limit = {
			OR = {
				is_nearby_for_popup = yes
				is_major_for_popup = yes
			}
		}
		eaw_diplo_popup_generate_unique_id = yes
		eaw_diplo_popup_initiate_cooldown = yes
		add_to_array = { eaw_diplo_popup_unique_id = temp_unique_popup_id }
		add_to_array = { eaw_diplo_popup_sender = FROM }
		add_to_array = { eaw_diplo_popup_reciever = FROM.FROM }
		add_to_array = { eaw_diplo_popup_type = 2 }
		add_to_array = { eaw_diplo_popup_initial_date = global.date }
		scoped_sound_effect = diplomatic_notification
	}
}

show_puppeted_popup = {
	if = {
		limit = {
			OR = {
				is_nearby_for_popup = yes
				is_major_for_popup = yes
			}
		}
		eaw_diplo_popup_generate_unique_id = yes
		eaw_diplo_popup_initiate_cooldown = yes
		add_to_array = { eaw_diplo_popup_unique_id = temp_unique_popup_id }
		add_to_array = { eaw_diplo_popup_sender = FROM }
		add_to_array = { eaw_diplo_popup_reciever = FROM.FROM }
		add_to_array = { eaw_diplo_popup_type = 3 }
		add_to_array = { eaw_diplo_popup_initial_date = global.date }
		scoped_sound_effect = diplomatic_notification
	}
}

show_on_daily_puppeted_popup = {
	if = {
		limit = {
			OR = {
				is_nearby_for_popup_on_daily = yes
				is_major_for_popup_on_daily = yes
			}
		}
		eaw_diplo_popup_generate_unique_id = yes
		eaw_diplo_popup_initiate_cooldown = yes
		add_to_array = { eaw_diplo_popup_unique_id = temp_unique_popup_id }
		add_to_array = { eaw_diplo_popup_sender = PREV }
		add_to_array = { eaw_diplo_popup_reciever = ROOT }
		add_to_array = { eaw_diplo_popup_type = 3 }
		add_to_array = { eaw_diplo_popup_initial_date = global.date }
		scoped_sound_effect = diplomatic_notification
	}
}

show_free_popup = {
	if = {
		limit = {
			OR = {
				is_nearby_for_popup = yes
				is_major_for_popup = yes
			}
		}
		eaw_diplo_popup_generate_unique_id = yes
		eaw_diplo_popup_initiate_cooldown = yes
		add_to_array = { eaw_diplo_popup_unique_id = temp_unique_popup_id }
		add_to_array = { eaw_diplo_popup_sender = PREV }
		add_to_array = { eaw_diplo_popup_reciever = ROOT }
		add_to_array = { eaw_diplo_popup_type = 6 }
		add_to_array = { eaw_diplo_popup_initial_date = global.date }
		scoped_sound_effect = diplomatic_notification
	}
}

show_on_daily_free_popup = {
	if = {
		limit = {
			OR = {
				is_nearby_for_popup_on_daily = yes
				is_major_for_popup_on_daily = yes
			}
		}
		eaw_diplo_popup_generate_unique_id = yes
		eaw_diplo_popup_initiate_cooldown = yes
		add_to_array = { eaw_diplo_popup_unique_id = temp_unique_popup_id }
		add_to_array = { eaw_diplo_popup_sender = PREV }
		add_to_array = { eaw_diplo_popup_reciever = ROOT }
		add_to_array = { eaw_diplo_popup_type = 6 }
		add_to_array = { eaw_diplo_popup_initial_date = global.date }
		scoped_sound_effect = diplomatic_notification
	}
}

show_on_daily_become_major_popup = {
	if = {
		limit = {
			OR = {
				is_nearby_for_popup_on_daily = yes
				is_major_for_popup_on_daily = yes
			}
		}
		eaw_diplo_popup_generate_unique_id = yes
		eaw_diplo_popup_initiate_cooldown = yes
		add_to_array = { eaw_diplo_popup_unique_id = temp_unique_popup_id }
		add_to_array = { eaw_diplo_popup_sender = PREV }
		add_to_array = { eaw_diplo_popup_reciever = PREV }
		add_to_array = { eaw_diplo_popup_type = 7 }
		add_to_array = { eaw_diplo_popup_initial_date = global.date }
		scoped_sound_effect = diplomatic_notification
	}
}

show_on_daily_lose_major_popup = {
	if = {
		limit = {
			OR = {
				is_nearby_for_popup_on_daily = yes
				check_variable = {
					eaw_major_diplo_popups = 2
				}
			}
		}
		eaw_diplo_popup_generate_unique_id = yes
		eaw_diplo_popup_initiate_cooldown = yes
		add_to_array = { eaw_diplo_popup_unique_id = temp_unique_popup_id }
		add_to_array = { eaw_diplo_popup_sender = PREV }
		add_to_array = { eaw_diplo_popup_reciever = PREV }
		add_to_array = { eaw_diplo_popup_type = 8 }
		add_to_array = { eaw_diplo_popup_initial_date = global.date }
		scoped_sound_effect = diplomatic_notification
	}
}

save_current_subjects = {
	clear_array = old_subjects
	if = {
		limit = { exists = yes }
		for_each_loop = {
			array = subjects
			add_to_array = { old_subjects = v }
		}
	}
}

# Generates unique id used to identify the popup instance
eaw_diplo_popup_generate_unique_id = {
	set_temp_variable_to_random = {
		var = temp_unique_popup_id
		min = 1
		max = 1208
		integer = yes
	}
	log = "generated unique popup id: [?temp_unique_popup_id]"
}

# Triggers the automatic dismissal of popup in three days
eaw_diplo_popup_initiate_cooldown = {
	var:temp_unique_popup_id = {
		save_event_target_as = unique_id
	}
	country_event = { id = diplopopup.99 days = 3 }
}

# Scripted effect that closes a popup entry given an index
# arg: close_index
eaw_diplo_popup_close_popup = {
	remove_from_array = { array = eaw_diplo_popup_unique_id index = close_index }
	remove_from_array = { array = eaw_diplo_popup_sender index = close_index }
	remove_from_array = { array = eaw_diplo_popup_reciever index = close_index }
	remove_from_array = { array = eaw_diplo_popup_initial_date index = close_index }
	remove_from_array = { array = eaw_diplo_popup_type index = close_index }
	scoped_sound_effect = menu_close_window
}