# This needs to be called if a focus starts the NZW
NZW_on_start_effect = {
	custom_effect_tooltip = NZW_starts_the_NZW
	
	set_global_flag = NZW_started
	set_global_flag = NZW_in_progress
	
	if = {
		limit = {
			NZ2 = {
				tag = HIE # Star Father is at it
			}
		}
		set_global_flag = NZW_war_status_total
		set_global_flag = NZW_war_status_partial_blocked
	}
	else = {
		set_global_flag = NZW_war_status_partial
	}
	
	if = {
		limit = {
			WNG = {
				has_government = fascism
			}
		}
		WNG = {
			# TODO: Wingbardy invitation
		}
	}
	if = {
		limit = {
			NOT = {
				has_global_flag = HIP_north_war_news_event_fired
			}
		}
		set_global_flag = HIP_north_war_news_event_fired
		news_event = {
			id = north_war.101
			hours = 8
		}
	}
	
	# IMPORTANT:
	# War participation is set in the in eaw_on_actions.txt -> on_war_relation_added
	# If you want to change something, look at the on_action itself
	# It is called for every nation once they enter the war, that's why its used (more flexible)
}

NZW_HIP_surrender_peace_deal_effect = {
	if = {
		limit = {
			WNG = {
				has_country_flag = NZW_war_participant
			}
		}
		set_global_flag = NZW_WNG_participated
		
		# WNG receives its islands
		if = {
			limit = {
				687 = {
					is_owned_by = HIP
				}
			}
			WNG = {
				transfer_state = 687
			}
		}
		if = {
			limit = {
				694 = {
					is_owned_by = HIP
				}
			}
			WNG = {
				transfer_state = 694
			}
		}
		if = {
			limit = {
				693 = {
					is_owned_by = HIP
				}
			}
			WNG = {
				transfer_state = 693
			}
		}
	}
	if = {
		limit = { # Split peacedeal
			NZ1 = {
				has_country_flag = NZW_war_participant
			}
			NZ2 = {
				has_country_flag = NZW_war_participant
			}
		}
		
		NZ1 = {
			# Northern Zumidia
			transfer_state = 711
			transfer_state = 698
			transfer_state = 697
		}
		
		NZ2 = {	
			# Warzena
			if = {
				limit = {
					WAR = { 
						NZW_is_aligned_with_HIP = yes
						OR = {
							has_country_flag = NZW_war_participant
							exists = no # Occupied by HIP
						}
					}
				}
				transfer_state = 688
				transfer_state = 1206
				transfer_state = 743
				transfer_state = 744
			}
			
			# Southern Zumidia
			transfer_state = 710
		}
		
		if = {
			limit = {
				AND = {
					NZ1 = {
						tag = CTH
					}
					NZ2 = {
						tag = BAT
					}
					has_global_flag = NZW_WNG_participated
				}
			}
			
			# Establish Winggarten
			set_global_flag = NZW_winggarten_established
			NZW_establish_winggarten_effect = yes
		}
	}
	else_if = { # Northern peacedeal
		limit = {
			NZ1 = {
				has_country_flag = NZW_war_participant
			}
		}
		
		NZ1 = {
			# Zumidia
			transfer_state = 711
			transfer_state = 698
			transfer_state = 697
			transfer_state = 710
			
			# Warzena
			if = {
				limit = {
					WAR = { 
						NZW_is_aligned_with_HIP = yes
						OR = {
							has_country_flag = NZW_war_participant
							exists = no # Occupied by HIP
						}
					}
				}
				transfer_state = 688
				transfer_state = 1206
				transfer_state = 743
				transfer_state = 744
			}
		}
	}
	else_if = { # Southern peacedeal
		limit = {
			NZ2 = {
				has_country_flag = NZW_war_participant
			}
		}
		
		NZ2 = {
			# Zumidia
			transfer_state = 711
			transfer_state = 698
			transfer_state = 697
			transfer_state = 710
			
			# Warzena
			if = {
				limit = {
					WAR = { 
						NZW_is_aligned_with_HIP = yes
						OR = {
							has_country_flag = NZW_war_participant
							exists = no # Occupied by HIP
						}
					}
				}
				transfer_state = 688
				transfer_state = 1206
				transfer_state = 743
				transfer_state = 744
			}
		}
	}
	else = {
		custom_effect_tooltip = NZW_error_tp # Nobody at war - this shouldn't happen
	}
	
	ZUM = {
		every_core_state = {
			remove_core_of = HIP
		}
	}
	WAR = {
		every_core_state = {
			remove_core_of = HIP
		}
	}
	
	NZW_on_end_effect = yes # North Zebrican War has officially ended, remove all war participations
}

NZW_establish_winggarten_effect = {
	1204 = {
		add_core_of = WIN
	}
	WIN = {
		transfer_state = 1204
		load_oob = "WIN_1007"
		give_military_access = BAT
		give_military_access = CTH
		give_military_access = WNG
		diplomatic_relation = {
			country = BAT
			relation = docking_rights
			active = yes
		}
		diplomatic_relation = {
			country = CTH
			relation = docking_rights
			active = yes
		}
		diplomatic_relation = {
			country = WNG
			relation = docking_rights
			active = yes
		}
		add_opinion_modifier = {
			target = BAT
			modifier = WIN_glorified_colony_2
		}
		add_opinion_modifier = {
			target = CTH
			modifier = WIN_glorified_colony_2
		}
		add_opinion_modifier = {
			target = WNG
			modifier = WIN_glorified_colony_2
		}
		set_variable = {
			var = WIN_WNG_influence
			value = 0.33
		}
		set_variable = {
			var = WIN_BAT_influence
			value = 0.34
		}
		set_variable = {
			var = WIN_CTH_influence
			value = 0.33
		}
		clamp_variable = {
			var = WIN_WNG_influence
			min = 0
			max = 1
		}
		clamp_variable = {
			var = WIN_BAT_influence
			min = 0
			max = 1
		}
		clamp_variable = {
			var = WIN_CTH_influence
			min = 0
			max = 1
		}
	}
	BAT = {
		give_guarantee = WIN
		diplomatic_relation = {
			country = WIN
			relation = docking_rights
			active = yes
		}
		WIN = {
			transfer_technology = yes
		}
		add_opinion_modifier = {
			target = WIN
			modifier = WIN_glorified_colony
		}
	}
	CTH = {
		give_guarantee = WIN
		diplomatic_relation = {
			country = WIN
			relation = docking_rights
			active = yes
		}
		WIN = {
			transfer_technology = yes
		}
		add_opinion_modifier = {
			target = WIN
			modifier = WIN_glorified_colony
		}
		CTH_azizelquart_zahummid = {
			set_nationality = WIN
			add_country_leader_role = {
				country_leader = {
					desc = WIN_AZIZELQUART_ZAHUMIND_DESC
					ideology = plutocracy
					expire = "1965.1.1.1"
					traits = {
						financial_expert
					}
				}
			}
		}
	}
	WNG = {
		give_guarantee = WIN
		diplomatic_relation = {
			country = WIN
			relation = docking_rights
			active = yes
		}
		WIN = {
			transfer_technology = yes
		}
		add_opinion_modifier = {
			target = WIN
			modifier = WIN_glorified_colony
		}
	}
	HIP = {
		add_ideas = WIN_economic_concessions
	}
	WIN = {
		complete_national_focus = WIN_the_establishment
		add_ideas = CTH_azizelquart_zahummid
	}
	1164 = {
		set_demilitarized_zone = yes
	}
}

# Purely for tooltip generation
NZW_show_projected_peacedeal = {

	# NOTE: The order matters here. The game picks the FIRST out of the list (else_if behaviour)

	if = {
		limit = {
			NZ1 = {
				tag = BAT
				has_country_flag = NZW_war_participant
			}
			NZ2 = {
				tag = CTH
				has_country_flag = NZW_war_participant
			}
			WNG = {
				has_country_flag = NZW_war_participant
			}
		}
		custom_effect_tooltip = peace_split_and_with_wingbardy_and_winggarten_tp
	}
	else_if = {	
		limit = {
			NZ1 = {
				has_country_flag = NZW_war_participant
			}
			NZ2 = {
				has_country_flag = NZW_war_participant
			}
			WNG = {
				has_country_flag = NZW_war_participant
			}
		}
		custom_effect_tooltip = peace_split_and_with_wingbardy_tp
	}
	else_if = {
		limit = {
			NZ1 = {
				has_country_flag = NZW_war_participant
			}
			NZ2 = {
				has_country_flag = NZW_war_participant
			}
		}
		custom_effect_tooltip = peace_split_tp
	}
	else_if = {
		limit = {
			NZ1 = {
				has_country_flag = NZW_war_participant
			}
			WNG = {
				has_country_flag = NZW_war_participant
			}
		}
		custom_effect_tooltip = peace_north_and_with_wingbardy
	}
	else_if = {
		limit = {
			NZ2 = {
				has_country_flag = NZW_war_participant
			}
			WNG = {
				has_country_flag = NZW_war_participant
			}
		}
		custom_effect_tooltip = peace_south_and_with_wingbardy
	}
	else_if = {
		limit = {
			NZ1 = {
				has_country_flag = NZW_war_participant
			}
		}
		custom_effect_tooltip = peace_north
	}
	else_if = {
		limit = {
			NZ2 = {
				has_country_flag = NZW_war_participant
			}
		}
		custom_effect_tooltip = peace_south
	}
	else = {
		custom_effect_tooltip = NZW_error_tp
	}
}

NZW_on_end_effect = {
	set_global_flag = NZW_ended
	clr_global_flag = NZW_in_progress
	
	every_possible_country = { # We don't want resurrected countries to cause shenanigans
		clr_country_flag = NZW_war_participant
	}
}

NZW_on_bypass_effect = { # For some reason, the NZW got avoided altogether
	set_global_flag = NZW_started
	set_global_flag = NZW_ended
	set_global_flag = NZW_bypassed
}

NZW_alliance_effect = {
	custom_effect_tooltip = NZW_alliance_effect_tooltip
	
	if = {
		limit = {
			OR = { # Alliance is possible
				AND = {
					tag = NZ1 # North
					NOT = { has_country_flag = NZW_no_alliance }
					NZW_is_southern_party_ready = yes # South is ready
					NZ2 = { # South wants to fight
						NZW_is_hostile_to_HIP = yes
						NOT = { has_country_flag = NZW_no_alliance }
					}
				}
				AND = {
					tag = NZ2 # South
					NOT = { has_country_flag = NZW_no_alliance }
					NZW_is_northern_party_ready = yes # North is ready
					NZ1 = { # North wants to fight
						NZW_is_hostile_to_HIP = yes
						NOT = { has_country_flag = NZW_no_alliance }
					}
				}
			}
			
			# If they are not faction leader, the can't ally
			NZ1 = {
				OR = {
					is_faction_leader = yes
					is_in_faction = no
				}
			}
			NZ2 = {
				OR = {
					is_faction_leader = yes
					is_in_faction = no
				}
			}
			
			NOT = { has_global_flag = NZW_alliance_effect_done } # Don't double trigger
		}
		set_global_flag = NZW_alliance_effect_done
		
		if = {
			limit = {
				tag = NZ1
			}
			set_global_flag = NZW_NZ1_alliance_proposer
		}
		else = {
			set_global_flag = NZW_NZ2_alliance_proposer
		}
		
		country_event = north_war_alliance.1 # Get offer for signing an alliance
	}
}

NZW_HIP_war_prep_effect = {
	if = {
		limit = {
			WAR = {
				OR = {
					is_in_faction_with = HIP
					is_guaranteed_by = HIP
				}
			}
		}
		HIP = {
			country_event = {
				id = bat.71
			}
		}
	}
}

# THIS IS THE DISSOLVING CODE
# Called by north_war_alliance.6 (if either partner wanted to dissolve)
# For giving the option to dissolve, call north_war_alliance.5 (only works if called for both)
NZW_alliance_dissolve_effect = {
	dismantle_faction = yes
	
	NZ1 = {
		if = {
			limit = {
				has_country_flag = NZW_was_faction_leader
			}
			create_faction = CTH_anti_bat_faction
			every_country = {
				limit = {
					has_country_flag = NZW_was_in_NZ1_faction
				}
				NZ1 = {
					add_to_faction = PREV
				}
			}
		}
	}
	
	NZ2 = {
		if = {
			limit = {
				has_country_flag = NZW_was_faction_leader
			}
			if = {
				limit = {
					tag = BAT
				}
				create_faction = BAT_lunar_hegemony
			}
			else = {
				create_faction = "Nothing to see here"
			}
			every_country = {
				limit = {
					has_country_flag = NZW_was_in_NZ2_faction
				}
				NZ1 = {
					add_to_faction = PREV
				}
			}
		}
	}

	NZ1 = {
		add_ai_strategy = {
			id = NZ2
			type = alliance
			value = -200
		}
		add_ai_strategy = {
			type = antagonize
			id = NZ2
			value = 200
		}
	}
	NZ2 = {
		add_ai_strategy = {
			id = NZ1
			type = alliance
			value = -200
		}
		add_ai_strategy = {
			type = antagonize
			id = NZ1
			value = 200
		}
	}
	NZ1 = {
		add_opinion_modifier = {
			target = NZ2
			modifier = enemies
		}
		reverse_add_opinion_modifier = {
			target = NZ2
			modifier = enemies
		}
	}
}
