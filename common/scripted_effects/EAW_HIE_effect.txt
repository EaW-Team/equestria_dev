### Misc Effects ###
HIE_CTH_increase_state_level = {
    if = {
	    limit = {
		    FROM = {
			    OR = {
			        has_state_category = wasteland 
					has_state_category = enclave  
					has_state_category = tiny_island 
				}
			}
		}
		set_state_category = pastoral 
	}
	else_if = {
	    limit = {
		    FROM = {
			    OR = {
			        has_state_category = small_island  
					has_state_category = pastoral  
				}
			}
		}
		set_state_category = rural  
	}
	else_if = {
	    limit = {
		    FROM = {
			    has_state_category = rural  
			}
		}
		set_state_category = town   
	}
	else_if = {
	    limit = {
		    FROM = {
			    has_state_category = town  
			}
		}
		set_state_category = large_town    
	}
	else_if = {
	    limit = {
		    FROM = {
			    has_state_category = large_town   
			}
		}
		set_state_category = city    
	}
	else_if = {
	    limit = {
		    FROM = {
			    has_state_category = city   
			}
		}
		set_state_category = large_city     
	}
	else_if = {
	    limit = {
		    FROM = {
			    has_state_category = large_city   
			}
		}
		set_state_category = metropolis     
	}
	else_if = {
	    limit = {
		    FROM = {
			    has_state_category = metropolis    
			}
		}
		set_state_category = megalopolis      
	}
}

### Alchemical Superproject ###
HIE_Alchemical_Superproject_debug_start = {
	set_country_flag = HIE_ASPJ_is_active
	set_country_flag = HIE_ASPJ_arrows_show
	clear_variable = HIE_created_concoction

	clear_array = HIE_placed_ingredients
	add_to_array = { HIE_placed_ingredients = 0 }
	add_to_array = { HIE_placed_ingredients = 0 }
	add_to_array = { HIE_placed_ingredients = 0 }
	
	# Computes position for the 3 buttons on the tablet
	clear_array = HIE_placed_ingredients_x
	clear_array = HIE_placed_ingredients_y
	add_to_array = { HIE_placed_ingredients_x = 218 }
	add_to_array = { HIE_placed_ingredients_x = 77 }
	add_to_array = { HIE_placed_ingredients_x = 361 }
	add_to_array = { HIE_placed_ingredients_y = 60 }
	add_to_array = { HIE_placed_ingredients_y = 319 }
	add_to_array = { HIE_placed_ingredients_y = 319 }
	
	# Computes ingredients, here for testing, remove later
	clear_array = HIE_ASPJ_ingredientlist
	set_temp_variable = { temp_debug_ingredients = 1 }
	for_loop_effect = {
		end = 24
		add_to_array = { HIE_ASPJ_ingredientlist = temp_debug_ingredients }
		add_to_temp_variable = { temp_debug_ingredients = 1 }
	}
	
	# Journal
	clear_array = HIE_JRNL_dummy_array
	add_to_array = { HIE_JRNL_dummy_array = 0 }
	set_variable = { HIE_JRNL_bookmarked_page = 1 }
	
	set_country_flag = HIE_debug_popout
	
	add_to_variable = { HIE_ASPJ_dirty_var = 0.01 }
}

HIE_ASPJ_debug_remove_ingredients = {
	clear_array = HIE_ASPJ_ingredientlist
	add_to_variable = { HIE_ASPJ_dirty_var = 0.01 }
}

HIE_Alchemical_Superproject_start = {
	set_country_flag = HIE_ASPJ_is_active
	set_country_flag = HIE_ASPJ_arrows_show
	clear_array = HIE_placed_ingredients
	add_to_array = { HIE_placed_ingredients = 0 }
	add_to_array = { HIE_placed_ingredients = 0 }
	add_to_array = { HIE_placed_ingredients = 0 }
	
	# Computes position for the 3 buttons on the tablet
	clear_array = HIE_placed_ingredients_x
	clear_array = HIE_placed_ingredients_y
	add_to_array = { HIE_placed_ingredients_x = 218 }
	add_to_array = { HIE_placed_ingredients_x = 77 }
	add_to_array = { HIE_placed_ingredients_x = 361 }
	add_to_array = { HIE_placed_ingredients_y = 60 }
	add_to_array = { HIE_placed_ingredients_y = 319 }
	add_to_array = { HIE_placed_ingredients_y = 319 }
	
	# Journal
	clear_array = HIE_JRNL_dummy_array
	add_to_array = { HIE_JRNL_dummy_array = 0 }
	set_variable = { HIE_JRNL_bookmarked_page = 1 }
	
	add_to_variable = { HIE_ASPJ_dirty_var = 0.01 }
	
	custom_effect_tooltip = HIE_Alchemical_Superproject_start_tt
}

HIE_ASPJ_evaluate_recipe = {
	# Potion of True Fire
	if = {
		limit = {
			is_in_array = { array = HIE_placed_ingredients value = 1 }
			is_in_array = { array = HIE_placed_ingredients value = 2 }
			is_in_array = { array = HIE_placed_ingredients value = 3 }
		}
		set_variable = { HIE_created_concoction = 1 }
		clear_variable = HIE_ASPJ_selected_formula
		scoped_sound_effect = "HIE_magic_concoction_complete"
	}
	# Essense of Endurance
	else_if = {
		limit = {
			is_in_array = { array = HIE_placed_ingredients value = 4 }
			is_in_array = { array = HIE_placed_ingredients value = 5 }
			is_in_array = { array = HIE_placed_ingredients value = 6 }
		}
		set_variable = { HIE_created_concoction = 2 }
		clear_variable = HIE_ASPJ_selected_formula
		scoped_sound_effect = "HIE_magic_concoction_complete"
	}
	# Primeval Magic Crystal
	else_if = {
		limit = {
			is_in_array = { array = HIE_placed_ingredients value = 7 }
			is_in_array = { array = HIE_placed_ingredients value = 8 }
			is_in_array = { array = HIE_placed_ingredients value = 9 }
		}
		set_variable = { HIE_created_concoction = 3 }
		clear_variable = HIE_ASPJ_selected_formula
		scoped_sound_effect = "HIE_magic_concoction_complete"
	}
	# Essence of Loyalty
	else_if = {
		limit = {
			is_in_array = { array = HIE_placed_ingredients value = 10 }
			is_in_array = { array = HIE_placed_ingredients value = 11 }
			is_in_array = { array = HIE_placed_ingredients value = 12 }
		}
		set_variable = { HIE_created_concoction = 4 }
		clear_variable = HIE_ASPJ_selected_formula
		scoped_sound_effect = "HIE_magic_concoction_complete"
	}
	# Vespers of Invincibility
	else_if = {
		limit = {
			is_in_array = { array = HIE_placed_ingredients value = 13 }
			is_in_array = { array = HIE_placed_ingredients value = 14 }
			is_in_array = { array = HIE_placed_ingredients value = 15 }
		}
		set_variable = { HIE_created_concoction = 5 }
		clear_variable = HIE_ASPJ_selected_formula
		scoped_sound_effect = "HIE_magic_concoction_complete"
	}
	# Heartbreaker
	else_if = {
		limit = {
			is_in_array = { array = HIE_placed_ingredients value = 16 }
			is_in_array = { array = HIE_placed_ingredients value = 17 }
			is_in_array = { array = HIE_placed_ingredients value = 18 }
		}
		set_variable = { HIE_created_concoction = 6 }
		clear_variable = HIE_ASPJ_selected_formula
		scoped_sound_effect = "HIE_magic_concoction_complete"
	}
	# Seedling's Kiss
	else_if = {
		limit = {
			is_in_array = { array = HIE_placed_ingredients value = 19 }
			is_in_array = { array = HIE_placed_ingredients value = 20 }
			is_in_array = { array = HIE_placed_ingredients value = 21 }
		}
		set_variable = { HIE_created_concoction = 7 }
		clear_variable = HIE_ASPJ_selected_formula
		scoped_sound_effect = "HIE_magic_concoction_complete"
	}
	# Stormcaller's Brew
	else_if = {
		limit = {
			is_in_array = { array = HIE_placed_ingredients value = 22 }
			is_in_array = { array = HIE_placed_ingredients value = 23 }
			is_in_array = { array = HIE_placed_ingredients value = 24 }
		}
		set_variable = { HIE_created_concoction = 8 }
		clear_variable = HIE_ASPJ_selected_formula
		scoped_sound_effect = "HIE_magic_concoction_complete"
	}
	# Failed concoction
	else = {
		clear_variable = HIE_created_concoction
		clear_variable = HIE_ASPJ_selected_formula

		for_each_loop = { # Returns ingredients to ingredients list, empties placed ingredients
			array = HIE_placed_ingredients
			add_to_array = { HIE_ASPJ_ingredientlist = HIE_placed_ingredients^i }
			set_variable = { HIE_placed_ingredients^i = 0 }
		}
		HIE_ASPJ_initiate_90day_cooldown = yes
		clr_country_flag = HIE_ASPJ_open
		country_event = hippone_aspj.0
	}
}

HIE_ASPJ_fire_concoction_event = {
	meta_effect = {
		text = {
			country_event = hippone_aspj.[HIE_event]
		}
		HIE_event = "[?HIE_created_concoction|.0]"
	}

	for_each_loop = {
		array = HIE_placed_ingredients
		set_variable = { HIE_placed_ingredients^i = 0 }
	}
	HIE_ASPJ_initiate_30day_cooldown = yes
	clear_variable = HIE_created_concoction
	clr_country_flag = HIE_ASPJ_open
	add_to_variable = { HIE_ASPJ_dirty_var = 0.01 }
}

asdaksdasodaos = {
	load_focus_tree = hippone_tree_2
}

# `set_country_flag` has a days argument but I couldn't dirty var them...
HIE_ASPJ_initiate_30day_cooldown = {
	set_country_flag = HIE_ASPJ_cooldown
	set_country_flag = HIE_ASPJ_30days_cooldown
	set_variable = { HIE_ASPJ_days_remaining_cooldown = 30 } # 30 days cooldown for successful concoction

	# Takes into account speed modifier (100% + modifier%)*30

	set_temp_variable = { ASPJ_cooldown_pct = 1 }
	add_to_temp_variable = { ASPJ_cooldown_pct = modifier@HIE_ASPJ_cooldown_speed_factor }
	multiply_variable = { HIE_ASPJ_days_remaining_cooldown = ASPJ_cooldown_pct }
	round_variable = HIE_ASPJ_days_remaining_cooldown
	
	add_to_variable = { HIE_ASPJ_days_remaining_cooldown = 1 }
	country_event = hippone_aspj.1999
	add_to_variable = { HIE_ASPJ_dirty_var = 0.01 }
}

HIE_ASPJ_initiate_90day_cooldown = {
	set_country_flag = HIE_ASPJ_cooldown
	set_country_flag = HIE_ASPJ_90days_cooldown
	set_variable = { HIE_ASPJ_days_remaining_cooldown = 90 } # 90 days cooldown for successful concoction

	# Takes into account speed modifier (100% + modifier%)*90

	set_temp_variable = { ASPJ_cooldown_pct = 1 }
	add_to_temp_variable = { ASPJ_cooldown_pct = modifier@HIE_ASPJ_cooldown_speed_factor }
	multiply_variable = { HIE_ASPJ_days_remaining_cooldown = ASPJ_cooldown_pct }
	round_variable = HIE_ASPJ_days_remaining_cooldown

	add_to_variable = { HIE_ASPJ_days_remaining_cooldown = 1 }
	country_event = hippone_aspj.1999
	add_to_variable = { HIE_ASPJ_dirty_var = 0.01 }
}

# How to use:
# (in effects)
# set_temp_variable = { temp_ingredient = 1 }
# HIE_ASPJ_add_ingredient = yes

# This will add the ingredient with the id of 1 as well as tooltipping it.

HIE_ASPJ_add_ingredient = {
	add_to_array = { HIE_ASPJ_ingredientlist = temp_ingredient }
	custom_effect_tooltip = HIE_ASPJ_add_ingredient_tt
	add_to_variable = { HIE_ASPJ_dirty_var = 0.01 }
}

# Debug, do not use
c_HIE_ASPJ_add_ingredient = {
	set_temp_variable = { temp_ingredient = args^0 }
	HIE_ASPJ_add_ingredient = yes
}

##################
### Le Journal ###
##################

HIE_JRNL_clr_popup_vars = { # Closes the popup tab
	clear_variable = HIE_JRNL_ze_selected
	clear_variable = HIE_JRNL_eq_selected
	clear_variable = HIE_JRNL_gr_selected
	clear_variable = HIE_JRNL_time_event_delay
	clear_variable = HIE_JRNL_buddies_success_odds
}

HIE_JRNL_calculate_odds_of_success = {
	set_variable = { HIE_JRNL_success_odds = HIE_JRNL_base_success_odds } 

	# Buddy system
	add_to_variable = { HIE_JRNL_success_odds = HIE_JRNL_buddies_success_odds }
	# Modifiers
	add_to_variable = { HIE_JRNL_success_odds = modifier@HIE_JRNL_expedition_success_odds_factor }

	clamp_variable = { var = HIE_JRNL_success_odds min = 0 max = 1 }
}

HIE_JRNL_init_expedition = { # Expeditions are where you follow one path and cannot deviate from that until you find all the ingredients
	custom_effect_tooltip = HIE_JRNL_init_expedition_tt
	set_variable = { HIE_JRNL_active_expedition = temp_active_expedition }
}

HIE_JRNL_start_activity = { # Searches are places where you look for the ingredients themselves
	set_country_flag = HIE_JRNL_is_in_activity
	if = {
		limit = {
			has_variable = HIE_JRNL_ze_selected
		}
		set_variable = { HIE_JRNL_ongoing_activity = HIE_JRNL_ze_selected }
	}
	else_if = {
		limit = {
			has_variable = HIE_JRNL_eq_selected
		}
		set_variable = { HIE_JRNL_ongoing_activity = HIE_JRNL_eq_selected }
	}
	else_if = {
		limit = {
			has_variable = HIE_JRNL_gr_selected
		}
		set_variable = { HIE_JRNL_ongoing_activity = HIE_JRNL_gr_selected }
	}
	
	# Calculate RNG
	set_temp_variable = { temp_fail_chance = 1 }
	subtract_from_temp_variable = { temp_fail_chance = HIE_JRNL_success_odds }
	
	# Take into account modifiers for time taken # TODO: Uncomment when testing is finished.
	#set_temp_variable = { temp_time_taken = 1 }
	#add_to_temp_variable = { temp_time_taken = modifier@HIE_JRNL_expedition_speed_factor }
	#multiply_variable = { HIE_JRNL_time_event_delay = temp_time_taken }
	
	# The RNG script (I hate paradox's RNG)
	random_list = {
		HIE_JRNL_success_odds = {
			meta_effect = { # Meta effects are in `EAW_HIE_scripted_localisation`
				text = {
					country_event = { id = [JRNL_REGION].[JRNL_VAR] days = 1 } # Normal is using `HIE_JRNL_time_event_delay`, this is for testing.
				}
				JRNL_REGION = "[HIE_JRNL_ME_namespace]"
				JRNL_VAR = "[?HIE_JRNL_ongoing_activity|.0]"
			}
			log = "[ROOT.Getname]: [HIE_JRNL_ME_namespace].[?HIE_JRNL_ongoing_activity] Succeeded with [?HIE_JRNL_success_odds|%] odds of success"
		}
		temp_fail_chance = {
			meta_effect = {
				text = {
					country_event = { id = [JRNL_REGION].0 days = 1 } # Normal is 14
				}
				JRNL_REGION = "[HIE_JRNL_ME_namespace]"
			}
			log = "[ROOT.Getname]: failed with [?temp_fail_chance|%] odds of failure"
		}
	}
	HIE_JRNL_clr_popup_vars = yes
	clear_variable = HIE_JRNL_success_odds
	clear_variable = HIE_JRNL_time_event_delay
}

HIE_JRNL_expedition_clean = { # Fired through events
	clr_country_flag = HIE_JRNL_is_in_activity
	clear_variable = HIE_JRNL_ongoing_activity
}